<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZG WatchTogether | ZeroGrevity</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --primary: #3b82f6;
        }

        body {
            background-color: var(--bg-dark);
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        /* Login Screen Animation */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Video Container */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            background: black;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .video-container iframe, 
        .video-container video {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="h-screen w-screen relative">

    <!-- ==================== LOGIN VIEW ==================== -->
    <div id="login-view" class="absolute inset-0 z-50 flex items-center justify-center bg-slate-900 bg-[url('https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80&w=2525&auto=format&fit=crop')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div>
        
        <div class="relative bg-slate-800/90 border border-slate-700 p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-8">
                <div class="bg-gradient-to-tr from-blue-500 to-purple-600 w-16 h-16 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i data-lucide="monitor-play" class="text-white w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">ZG WatchTogether</h1>
                <p class="text-slate-400 text-sm">Watch videos in sync with friends.</p>
            </div>

            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1 uppercase tracking-wider">Display Name</label>
                    <input type="text" id="username-input" required placeholder="Enter your name" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1 uppercase tracking-wider">Room ID (Optional)</label>
                    <div class="flex gap-2">
                        <input type="text" id="room-input" placeholder="e.g. movie-night" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition">
                        <button type="button" onclick="generateRoomId()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 rounded-lg" title="Generate Random ID">
                            <i data-lucide="shuffle" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3 rounded-lg shadow-lg transform active:scale-95 transition-all">
                    Enter Room
                </button>
            </form>
        </div>
    </div>


    <!-- ==================== MAIN APP VIEW ==================== -->
    <div id="app-view" class="flex flex-col h-full hidden">
        
        <!-- Header -->
        <header class="h-16 border-b border-slate-700 flex items-center justify-between px-4 md:px-6 bg-slate-900 z-20">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-tr from-blue-500 to-purple-600 p-1.5 rounded-lg">
                    <i data-lucide="monitor-play" class="text-white w-5 h-5"></i>
                </div>
                <div class="hidden md:block">
                    <h1 class="font-bold text-lg text-white leading-tight">WatchTogether</h1>
                    <p class="text-[10px] text-slate-400">Room: <span id="current-room-display" class="font-mono text-blue-400">...</span></p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div id="connection-status" class="flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 text-xs font-medium text-slate-400 border border-slate-700">
                    <div class="w-2 h-2 rounded-full bg-red-500"></div> Offline
                </div>
                
                <button onclick="copyRoomLink()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg transition text-xs font-bold border border-blue-500 shadow-lg shadow-blue-500/20">
                    <i data-lucide="share-2" class="w-3.5 h-3.5"></i> <span class="hidden md:inline">Invite</span>
                </button>

                <div class="w-8 h-8 rounded-full bg-slate-700 border border-slate-600 flex items-center justify-center text-white font-bold text-xs" id="user-avatar">
                    ME
                </div>
            </div>
        </header>

        <!-- Main Workspace -->
        <main class="flex-1 flex overflow-hidden">
            
            <!-- Left: Video Player & Controls -->
            <div class="flex-1 flex flex-col relative bg-black">
                
                <!-- Floating Controls (Top) -->
                <div class="absolute top-0 left-0 w-full p-4 z-10 opacity-0 hover:opacity-100 transition-opacity duration-300 bg-gradient-to-b from-black/90 to-transparent">
                    <div class="flex flex-wrap items-center justify-center gap-2 bg-slate-900/80 backdrop-blur border border-slate-700 p-2 rounded-xl max-w-2xl mx-auto">
                        
                        <div class="flex gap-2">
                            <button onclick="setSourceUI('youtube')" class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs text-white border border-slate-700 transition flex items-center gap-2">
                                <i data-lucide="youtube" class="w-3 h-3 text-red-500"></i> YouTube
                            </button>
                            <button onclick="triggerFileSelect()" class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs text-white border border-slate-700 transition flex items-center gap-2">
                                <i data-lucide="file-video" class="w-3 h-3 text-blue-500"></i> File
                            </button>
                        </div>

                        <div class="h-4 w-px bg-slate-700 mx-1"></div>

                        <div id="yt-controls" class="flex gap-2 hidden">
                            <input type="text" id="yt-input" placeholder="Paste YouTube URL..." class="bg-slate-950 border border-slate-700 text-xs px-3 py-1.5 rounded-lg w-48 text-white focus:border-blue-500 outline-none">
                            <button onclick="loadYouTube()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition">Play</button>
                        </div>
                        
                        <input type="file" id="local-file-input" accept="video/*" class="hidden" onchange="handleLocalFile(this)">
                    </div>
                </div>

                <!-- Stage -->
                <div class="flex-1 flex items-center justify-center p-2 md:p-6 overflow-y-auto">
                    <div class="w-full max-w-5xl video-container shadow-2xl" id="player-wrapper">
                        <!-- Placeholder -->
                        <div id="placeholder-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 text-slate-500">
                            <div class="bg-slate-800 p-4 rounded-full mb-4">
                                <i data-lucide="film" class="w-8 h-8 text-slate-400"></i>
                            </div>
                            <h3 class="text-lg font-medium text-white">No Video Loaded</h3>
                            <p class="text-xs mt-1">Select a source from the top menu to start watching.</p>
                        </div>
                        
                        <!-- Players -->
                        <video id="html5-player" class="hidden" controls></video>
                        <div id="youtube-player" class="hidden"></div>
                    </div>
                </div>

                <!-- Webcams (Bottom Strip) -->
                <div class="h-32 bg-slate-900 border-t border-slate-800 flex items-center px-4 gap-4 overflow-x-auto">
                    <!-- My Camera -->
                    <div class="relative w-40 h-24 bg-black rounded-lg overflow-hidden border border-slate-700 shrink-0 group shadow-md">
                        <video id="my-webcam" autoplay muted playsinline class="w-full h-full object-cover mirror"></video>
                        <div class="absolute bottom-1 left-1 bg-black/50 px-1.5 rounded text-[9px] text-white font-bold backdrop-blur">YOU</div>
                        
                        <!-- Cam Controls -->
                        <div class="absolute inset-0 bg-black/40 flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button id="btn-cam" onclick="toggleCam()" class="p-1.5 bg-slate-700 hover:bg-slate-600 rounded-full text-white transition">
                                <i data-lucide="video" class="w-4 h-4"></i>
                            </button>
                            <button id="btn-mic" onclick="toggleMic()" class="p-1.5 bg-slate-700 hover:bg-slate-600 rounded-full text-white transition">
                                <i data-lucide="mic" class="w-4 h-4"></i>
                            </button>
                        </div>
                        
                        <!-- Off States Indicators -->
                        <div id="cam-off-indicator" class="hidden absolute inset-0 bg-slate-800 flex flex-col items-center justify-center text-slate-500">
                            <i data-lucide="video-off" class="w-6 h-6 mb-1"></i>
                            <span class="text-[9px]">Camera Off</span>
                        </div>
                    </div>

                    <!-- Other User Placeholder (Demo) -->
                    <div class="relative w-40 h-24 bg-slate-800/50 rounded-lg flex flex-col items-center justify-center border border-dashed border-slate-700 shrink-0">
                        <i data-lucide="users" class="w-5 h-5 text-slate-600 mb-1"></i>
                        <span class="text-[10px] text-slate-500">Waiting for friends...</span>
                    </div>
                </div>
            </div>

            <!-- Right: Chat (Collapsible on Mobile) -->
            <div class="w-80 bg-slate-900 border-l border-slate-800 flex flex-col hidden md:flex">
                <div class="p-3 border-b border-slate-800 bg-slate-900/50">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wide">Live Chat</h2>
                </div>

                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Chat items go here -->
                </div>

                <div class="p-3 bg-slate-800/30 border-t border-slate-700">
                    <form onsubmit="sendMessage(event)" class="relative">
                        <input id="chat-input" type="text" placeholder="Say something..." class="w-full bg-slate-950 border border-slate-700 rounded-lg py-2 pl-3 pr-10 text-xs text-white focus:border-blue-500 outline-none transition">
                        <button type="submit" class="absolute right-1 top-1 p-1.5 text-slate-400 hover:text-blue-500 transition">
                            <i data-lucide="send-horizontal" class="w-4 h-4"></i>
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- STATE & CONFIG ---
        const config = {
            socketUrl: 'http://localhost:3000',
            demoMode: true
        };

        const state = {
            username: 'Guest',
            room: 'lobby',
            socket: null,
            isConnected: false,
            mediaStream: null,
            videoSource: null, // 'youtube' | 'file'
            ytPlayer: null
        };

        // --- 1. INITIALIZATION ---
        
        window.onload = () => {
            lucide.createIcons();
            // Pre-fill room if in URL
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('room')) document.getElementById('room-input').value = urlParams.get('room');
        };

        function generateRoomId() {
            const id = Math.random().toString(36).substring(2, 8);
            document.getElementById('room-input').value = id;
        }

        // --- 2. LOGIN FLOW ---

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username-input').value.trim();
            const room = document.getElementById('room-input').value.trim() || 'default-room';

            if(!username) return;

            // Save to state
            state.username = username;
            state.room = room;

            // UI Updates
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('user-avatar').innerText = username.substring(0, 2).toUpperCase();
            document.getElementById('current-room-display').innerText = room;

            addSystemMessage(`Welcome, ${username}! You joined room: ${room}`);

            // Initialize Systems
            await initWebcam();
            initSocketConnection();
            initYouTubeAPI();
        }

        // --- 3. SOCKET CONNECTION ---

        function initSocketConnection() {
            try {
                // Connect with query params
                state.socket = io(config.socketUrl, {
                    query: { username: state.username, room: state.room }
                });

                state.socket.on('connect', () => {
                    state.isConnected = true;
                    config.demoMode = false;
                    updateConnectionStatus(true);
                    addSystemMessage("Connected to synchronization server.");
                    
                    // Join the specific room event
                    state.socket.emit('join-room', { room: state.room, username: state.username });
                });

                state.socket.on('disconnect', () => {
                    state.isConnected = false;
                    updateConnectionStatus(false);
                });

                state.socket.on('chat-message', (data) => {
                    addChatMessage(data.user, data.msg, false);
                });

                state.socket.on('sync-action', (payload) => {
                    handleRemoteSync(payload);
                });

                // Connection Error Handler
                state.socket.on('connect_error', (err) => {
                    console.log("Socket connection failed, using Demo Mode.");
                    // Don't spam alert, just set status
                    updateConnectionStatus(false);
                });

            } catch (err) {
                console.error("Socket IO library not loaded or server missing.");
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(online) {
            const el = document.getElementById('connection-status');
            if(online) {
                el.innerHTML = `<div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div> Online`;
                el.classList.replace('text-slate-400', 'text-emerald-400');
            } else {
                el.innerHTML = `<div class="w-2 h-2 rounded-full bg-red-500"></div> Offline (Demo)`;
                el.classList.replace('text-emerald-400', 'text-slate-400');
            }
        }

        // --- 4. VIDEO LOGIC ---

        // YouTube
        function initYouTubeAPI() {
            if(!window.YT) {
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                const firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }
        }

        function setSourceUI(source) {
            const ytControls = document.getElementById('yt-controls');
            if(source === 'youtube') {
                ytControls.classList.remove('hidden');
                document.getElementById('yt-input').focus();
            } else {
                ytControls.classList.add('hidden');
            }
        }

        function loadYouTube() {
            const url = document.getElementById('yt-input').value;
            const videoId = extractVideoID(url);
            if(!videoId) {
                alert("Invalid YouTube URL");
                return;
            }

            activatePlayer('youtube');
            
            if(state.ytPlayer) {
                state.ytPlayer.loadVideoById(videoId);
            } else {
                state.ytPlayer = new YT.Player('youtube-player', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: { 'autoplay': 1, 'controls': 1 },
                    events: {
                        'onStateChange': onPlayerStateChange
                    }
                });
            }

            broadcastSync('change-video', { type: 'youtube', id: videoId });
        }

        function extractVideoID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // Local File
        function triggerFileSelect() {
            document.getElementById('local-file-input').click();
        }

        function handleLocalFile(input) {
            const file = input.files[0];
            if(!file) return;

            const url = URL.createObjectURL(file);
            activatePlayer('file');
            
            const v = document.getElementById('html5-player');
            v.src = url;
            v.play();

            // Attach listeners
            v.onplay = () => broadcastSync('play', v.currentTime);
            v.onpause = () => broadcastSync('pause', v.currentTime);
            v.onseeked = () => broadcastSync('seek', v.currentTime);
        }

        // Common Player Logic
        function activatePlayer(type) {
            document.getElementById('placeholder-screen').classList.add('hidden');
            const ytEl = document.getElementById('youtube-player');
            const html5El = document.getElementById('html5-player');
            
            state.videoSource = type;

            if(type === 'youtube') {
                html5El.classList.add('hidden');
                html5El.pause();
                ytEl.style.display = 'block'; // YT iframe needs display block
            } else {
                ytEl.style.display = 'none';
                if(state.ytPlayer && state.ytPlayer.pauseVideo) state.ytPlayer.pauseVideo();
                html5El.classList.remove('hidden');
            }
        }

        // Sync Handling
        function broadcastSync(action, data) {
            if(config.demoMode) {
                console.log(`[Demo Sync] ${action}`, data);
                return;
            }
            if(state.isConnected) {
                state.socket.emit('sync-action', { action, data });
            }
        }

        function handleRemoteSync(payload) {
            console.log("Received Sync:", payload);
            const { action, data } = payload;

            if(action === 'change-video') {
                if(data.type === 'youtube') {
                    document.getElementById('yt-input').value = `https://youtube.com/watch?v=${data.id}`;
                    loadYouTube();
                }
            }
            else if(action === 'play') {
                if(state.videoSource === 'file') {
                    const v = document.getElementById('html5-player');
                    if(Math.abs(v.currentTime - data) > 0.5) v.currentTime = data;
                    v.play();
                } else if(state.ytPlayer) {
                    state.ytPlayer.seekTo(data);
                    state.ytPlayer.playVideo();
                }
            }
            else if(action === 'pause') {
                if(state.videoSource === 'file') document.getElementById('html5-player').pause();
                else if(state.ytPlayer) state.ytPlayer.pauseVideo();
            }
        }

        // YT Event Bridge
        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) broadcastSync('play', state.ytPlayer.getCurrentTime());
            else if (event.data == YT.PlayerState.PAUSED) broadcastSync('pause', state.ytPlayer.getCurrentTime());
        }

        // --- 5. WEBCAM HANDLING (Fixed) ---

        async function initWebcam() {
            try {
                // Request audio too so toggleMic works
                state.mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const vid = document.getElementById('my-webcam');
                vid.srcObject = state.mediaStream;
            } catch (err) {
                console.warn("Webcam/Mic access denied or unavailable", err);
                addSystemMessage("Could not access camera/microphone. Check permissions.");
                // Update UI to show off state
                document.getElementById('cam-off-indicator').classList.remove('hidden');
                document.getElementById('btn-cam').classList.add('bg-red-500', 'hover:bg-red-600');
                document.getElementById('btn-mic').classList.add('bg-red-500', 'hover:bg-red-600');
            }
        }

        function toggleCam() {
            if(!state.mediaStream) { alert("Camera not active"); return; }
            
            const vidTracks = state.mediaStream.getVideoTracks();
            if(vidTracks.length > 0) {
                const enabled = !vidTracks[0].enabled;
                vidTracks[0].enabled = enabled;
                
                // UI Toggle
                const btn = document.getElementById('btn-cam');
                const ind = document.getElementById('cam-off-indicator');
                
                if(enabled) {
                    btn.classList.replace('bg-red-500', 'bg-slate-700');
                    btn.innerHTML = `<i data-lucide="video" class="w-4 h-4"></i>`;
                    ind.classList.add('hidden');
                } else {
                    btn.classList.replace('bg-slate-700', 'bg-red-500');
                    btn.innerHTML = `<i data-lucide="video-off" class="w-4 h-4"></i>`;
                    ind.classList.remove('hidden');
                }
                lucide.createIcons();
            }
        }

        function toggleMic() {
            if(!state.mediaStream) { alert("Microphone not active"); return; }
            
            const audTracks = state.mediaStream.getAudioTracks();
            if(audTracks.length > 0) {
                const enabled = !audTracks[0].enabled;
                audTracks[0].enabled = enabled;

                // UI Toggle
                const btn = document.getElementById('btn-mic');
                if(enabled) {
                    btn.classList.replace('bg-red-500', 'bg-slate-700');
                    btn.innerHTML = `<i data-lucide="mic" class="w-4 h-4"></i>`;
                } else {
                    btn.classList.replace('bg-slate-700', 'bg-red-500');
                    btn.innerHTML = `<i data-lucide="mic-off" class="w-4 h-4"></i>`;
                }
                lucide.createIcons();
            }
        }


        // --- 6. CHAT & UTILS ---

        function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;

            addChatMessage("You", msg, true);
            
            if(state.isConnected) state.socket.emit('chat-message', msg);
            else if(config.demoMode) {
                // Simulate reply in demo mode
                setTimeout(() => addChatMessage("Bot", "Demo Mode: Message not sent to network.", false), 500);
            }
            
            input.value = '';
        }

        function addChatMessage(user, msg, isMe) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            
            div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} animate-fade`;
            
            const bubbleColor = isMe ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-200';
            
            div.innerHTML = `
                <span class="text-[10px] text-slate-500 mb-1 px-1">${user}</span>
                <div class="${bubbleColor} px-3 py-2 rounded-xl text-xs max-w-[90%] leading-relaxed shadow-sm">
                    ${msg}
                </div>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(text) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = "flex justify-center my-2";
            div.innerHTML = `<span class="text-[10px] bg-slate-800/50 text-slate-500 px-2 py-0.5 rounded-full border border-slate-800">${text}</span>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function copyRoomLink() {
            // Robust Copy Logic
            const url = window.location.origin + window.location.pathname + '?room=' + state.room;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url)
                    .then(() => alert("Room Invite Link Copied!"))
                    .catch(err => manualCopy(url));
            } else {
                manualCopy(url);
            }
        }

        function manualCopy(text) {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed"; 
            ta.style.opacity = "0"; 
            document.body.appendChild(ta);
            ta.focus(); 
            ta.select();
            try {
                document.execCommand('copy');
                alert("Room Invite Link Copied!");
            } catch (e) {
                prompt("Copy this link:", text);
            }
            document.body.removeChild(ta);
        }

    </script>
</body>
</html>
