<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZG WatchTogether | ZeroGrevity</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose to window for app logic
        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion };
    </script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --primary: #3b82f6;
        }

        body {
            background-color: var(--bg-dark);
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px) translateX(-50%); } to { opacity: 1; transform: translateY(0) translateX(-50%); } }

        /* Video Container */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            background: black;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        
        /* Cinema Mode Effect */
        .video-container:hover {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }

        .video-container iframe, 
        .video-container video {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            outline: none;
        }

        /* Avatar Selection */
        .avatar-option {
            transition: all 0.2s;
            cursor: pointer;
            opacity: 0.6;
            transform: scale(0.9);
        }
        .avatar-option:hover { opacity: 1; transform: scale(1.05); }
        .avatar-option.selected {
            opacity: 1;
            transform: scale(1.1);
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        .ai-glow {
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.5);
        }

        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -4px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }
    </style>
</head>
<body class="h-screen w-screen relative">

    <!-- ==================== TOAST NOTIFICATIONS ==================== -->
    <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <!-- ==================== SETTINGS/PROFILE MODAL ==================== -->
    <dialog id="settings-modal" class="bg-transparent p-0 backdrop:bg-black/50 backdrop:backdrop-blur-sm w-full max-w-md">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl p-6 text-white">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5 text-blue-400"></i> Room & Profile
                </h2>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-white transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="space-y-6">
                <!-- Profile Section -->
                <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700/50">
                    <label class="block text-xs font-medium text-slate-400 mb-3 uppercase">Your Profile</label>
                    <div class="flex gap-4 items-center">
                        <div class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center text-2xl border border-slate-600" id="modal-avatar-preview">üëæ</div>
                        <div class="flex-1">
                            <input type="text" id="setting-username" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none" placeholder="Display Name">
                        </div>
                    </div>
                    <div class="mt-3 flex gap-2 justify-center">
                        <button onclick="updateModalAvatar('üëæ')" class="p-2 hover:bg-slate-700 rounded-full">üëæ</button>
                        <button onclick="updateModalAvatar('üê±')" class="p-2 hover:bg-slate-700 rounded-full">üê±</button>
                        <button onclick="updateModalAvatar('ü§ñ')" class="p-2 hover:bg-slate-700 rounded-full">ü§ñ</button>
                        <button onclick="updateModalAvatar('ü¶ä')" class="p-2 hover:bg-slate-700 rounded-full">ü¶ä</button>
                        <button onclick="updateModalAvatar('üëª')" class="p-2 hover:bg-slate-700 rounded-full">üëª</button>
                    </div>
                </div>

                <!-- Room Section -->
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1 uppercase">Room Name</label>
                    <input type="text" id="setting-room-name" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none">
                </div>

                <!-- Permissions -->
                <div class="flex items-center justify-between mb-3 bg-slate-900/30 p-3 rounded-lg">
                    <span class="text-sm">Host-Only Controls</span>
                    <button id="toggle-host-only" onclick="toggleHostMode()" class="w-10 h-5 rounded-full bg-slate-700 relative transition-colors">
                        <div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform"></div>
                    </button>
                </div>

                <!-- Danger Zone -->
                <div class="pt-4 border-t border-slate-700">
                    <button onclick="leaveRoom()" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-500 text-sm font-medium py-2 rounded-lg border border-red-500/20 transition">
                        Leave Room
                    </button>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold">Save Changes</button>
            </div>
        </div>
    </dialog>

    <!-- ==================== LOGIN VIEW ==================== -->
    <div id="login-view" class="absolute inset-0 z-50 flex items-center justify-center bg-slate-900 bg-[url('https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80&w=2525&auto=format&fit=crop')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div>
        
        <div class="relative bg-slate-800/90 border border-slate-700 p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-6">
                <div class="bg-gradient-to-tr from-blue-500 to-purple-600 w-16 h-16 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i data-lucide="monitor-play" class="text-white w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">ZG WatchTogether</h1>
                <p class="text-slate-400 text-sm">Join a room to watch in sync.</p>
            </div>

            <div id="login-loader" class="hidden flex justify-center py-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            </div>

            <form id="login-form" onsubmit="handleLogin(event)" class="space-y-5">
                <!-- Avatar Selection -->
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider text-center">Choose Avatar</label>
                    <div class="flex justify-center gap-3">
                        <div class="avatar-option w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-lg border-2 border-transparent" onclick="selectAvatar('üëæ', 'bg-blue-600')">üëæ</div>
                        <div class="avatar-option w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center text-lg border-2 border-transparent" onclick="selectAvatar('üê±', 'bg-purple-600')">üê±</div>
                        <div class="avatar-option w-10 h-10 rounded-full bg-emerald-600 flex items-center justify-center text-lg border-2 border-transparent" onclick="selectAvatar('ü§ñ', 'bg-emerald-600')">ü§ñ</div>
                        <div class="avatar-option w-10 h-10 rounded-full bg-orange-600 flex items-center justify-center text-lg border-2 border-transparent" onclick="selectAvatar('ü¶ä', 'bg-orange-600')">ü¶ä</div>
                        <div class="avatar-option w-10 h-10 rounded-full bg-pink-600 flex items-center justify-center text-lg border-2 border-transparent" onclick="selectAvatar('üëª', 'bg-pink-600')">üëª</div>
                    </div>
                    <input type="hidden" id="selected-avatar" value="üëæ">
                    <input type="hidden" id="selected-color" value="bg-blue-600">
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1 uppercase tracking-wider">Display Name</label>
                    <input type="text" id="username-input" required placeholder="Enter your name" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1 uppercase tracking-wider">Room ID</label>
                    <div class="flex gap-2">
                        <input type="text" id="room-input" placeholder="e.g. movie-night" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition">
                        <button type="button" onclick="generateRoomId()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 rounded-lg" title="Generate Random ID">
                            <i data-lucide="shuffle" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3 rounded-lg shadow-lg transform active:scale-95 transition-all">
                    Enter Room
                </button>
            </form>
        </div>
    </div>


    <!-- ==================== MAIN APP VIEW ==================== -->
    <div id="app-view" class="flex flex-col h-full hidden">
        
        <!-- Header -->
        <header class="h-16 border-b border-slate-700 flex items-center justify-between px-4 md:px-6 bg-slate-900 z-20">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-tr from-blue-500 to-purple-600 p-1.5 rounded-lg">
                    <i data-lucide="monitor-play" class="text-white w-5 h-5"></i>
                </div>
                <div class="hidden md:block">
                    <h1 class="font-bold text-lg text-white leading-tight">WatchTogether</h1>
                    <p class="text-[10px] text-slate-400">Room: <span id="current-room-display" class="font-mono text-blue-400">...</span></p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="toggleSettings()" class="p-2 text-slate-400 hover:text-white transition rounded-full hover:bg-slate-800" title="Room & Profile Settings">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>

                <div class="h-6 w-px bg-slate-700"></div>

                <div id="connection-status" class="flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 text-xs font-medium text-slate-400 border border-slate-700">
                    <div class="w-2 h-2 rounded-full bg-slate-500 animate-pulse"></div> Connecting...
                </div>
                
                <button onclick="copyRoomLink()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg transition text-xs font-bold border border-blue-500 shadow-lg shadow-blue-500/20">
                    <i data-lucide="share-2" class="w-3.5 h-3.5"></i> <span class="hidden md:inline">Invite</span>
                </button>

                <!-- User Profile Display -->
                <div class="w-9 h-9 rounded-full bg-slate-700 border border-slate-600 flex items-center justify-center text-white font-bold text-lg shadow-inner cursor-pointer" id="user-avatar-display" onclick="toggleSettings()">
                    ?
                </div>
            </div>
        </header>

        <!-- Main Workspace -->
        <main class="flex-1 flex overflow-hidden">
            
            <!-- Left: Video Player & Controls -->
            <div class="flex-1 flex flex-col relative bg-black">
                
                <!-- Floating Video Source Bar (Top) -->
                <div class="absolute top-0 left-0 w-full p-4 z-20 opacity-0 hover:opacity-100 transition-opacity duration-300 bg-gradient-to-b from-black/90 to-transparent">
                    <div class="flex flex-wrap items-center justify-center gap-2 bg-slate-900/90 backdrop-blur-md border border-slate-700 p-2 rounded-xl max-w-2xl mx-auto shadow-2xl">
                        
                        <div class="flex items-center w-full md:w-auto gap-2">
                             <div class="relative w-full">
                                <i data-lucide="link" class="absolute left-3 top-2.5 w-3 h-3 text-slate-500"></i>
                                <input type="text" id="url-input" placeholder="Paste YouTube or MP4 link..." 
                                    class="bg-slate-950 border border-slate-700 text-xs pl-8 pr-3 py-2 rounded-lg w-full md:w-64 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none placeholder-slate-600">
                             </div>
                             <button onclick="loadFromURL()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-blue-500/20">Play</button>
                        </div>
                        
                        <div class="h-4 w-px bg-slate-700 mx-1 hidden md:block"></div>

                        <button onclick="triggerFileSelect()" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs text-white border border-slate-700 transition flex items-center gap-2 whitespace-nowrap">
                            <i data-lucide="file-up" class="w-3 h-3 text-emerald-500"></i> Video File
                        </button>
                        
                        <input type="file" id="local-file-input" accept="video/*" class="hidden" onchange="handleLocalFile(this)">
                    </div>
                </div>

                <!-- Stage -->
                <div class="flex-1 flex items-center justify-center p-2 md:p-6 overflow-y-auto bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 to-black relative">
                    <div class="w-full max-w-5xl video-container shadow-2xl ring-1 ring-white/10" id="player-wrapper">
                        <!-- Placeholder -->
                        <div id="placeholder-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 text-slate-500 z-10">
                            <div class="bg-slate-800 p-6 rounded-full mb-4 animate-pulse">
                                <i data-lucide="film" class="w-10 h-10 text-slate-400"></i>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-1">Ready to Watch?</h3>
                            <p class="text-sm text-slate-400">Paste a link above or Select a file.</p>
                        </div>
                        
                        <!-- Players -->
                        <video id="html5-player" class="hidden" controls playsinline crossorigin="anonymous">
                            <track id="player-track" kind="subtitles" srclang="en" label="English" default>
                        </video>
                        <div id="youtube-player" class="hidden"></div>
                    </div>
                </div>

                <!-- Custom Control Bar (Below Video) -->
                <div class="w-full bg-slate-900 border-t border-slate-800 px-4 py-3 flex items-center justify-between shrink-0 z-20">
                    <div class="flex items-center gap-4">
                        <!-- Speed Control -->
                        <div class="flex items-center gap-2">
                             <span class="text-[10px] uppercase text-slate-500 font-bold">Speed</span>
                             <select id="speed-select" onchange="changeSpeed(this.value)" class="bg-slate-800 text-white text-xs border border-slate-700 rounded px-2 py-1 focus:outline-none focus:border-blue-500">
                                 <option value="0.5">0.5x</option>
                                 <option value="1" selected>1.0x</option>
                                 <option value="1.5">1.5x</option>
                                 <option value="2">2.0x</option>
                             </select>
                        </div>
                        
                        <!-- Subtitle Button -->
                        <button onclick="triggerSubtitleSelect()" class="flex items-center gap-1.5 px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded border border-slate-700 text-xs text-white transition">
                            <i data-lucide="captions" class="w-3.5 h-3.5"></i> Add Subtitles
                        </button>
                        <input type="file" id="subtitle-input" accept=".vtt,.srt" class="hidden" onchange="handleSubtitle(this)">
                    </div>

                    <!-- Room Status -->
                    <div class="flex items-center gap-2 text-xs text-slate-400">
                        <span id="sync-indicator" class="w-2 h-2 rounded-full bg-emerald-500"></span>
                        <span id="sync-text">Synced</span>
                    </div>
                </div>

                <!-- Webcams (Bottom Strip) -->
                <div class="h-36 bg-slate-950 border-t border-slate-800 flex items-center px-4 gap-4 overflow-x-auto shrink-0">
                    <!-- My Camera -->
                    <div class="relative w-48 h-28 bg-black rounded-xl overflow-hidden border border-slate-700 shrink-0 group shadow-md transition hover:border-blue-500/50">
                        <video id="my-webcam" autoplay muted playsinline class="w-full h-full object-cover mirror"></video>
                        <div class="absolute bottom-2 left-2 bg-black/60 px-2 py-0.5 rounded text-[10px] text-white font-bold backdrop-blur flex items-center gap-1">
                            <span id="cam-label-name">YOU</span>
                        </div>
                        
                        <!-- Cam Controls -->
                        <div class="absolute inset-0 bg-black/40 flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button id="btn-cam" onclick="toggleCam()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-full text-white transition">
                                <i data-lucide="video" class="w-4 h-4"></i>
                            </button>
                            <button id="btn-mic" onclick="toggleMic()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-full text-white transition">
                                <i data-lucide="mic" class="w-4 h-4"></i>
                            </button>
                        </div>
                        
                        <!-- Off States Indicators -->
                        <div id="cam-off-indicator" class="hidden absolute inset-0 bg-slate-800 flex flex-col items-center justify-center text-slate-500">
                            <i data-lucide="video-off" class="w-6 h-6 mb-1"></i>
                            <span class="text-[9px] mt-1">Camera Off</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Sidebar -->
            <div class="w-80 bg-slate-900 border-l border-slate-800 flex flex-col hidden md:flex">
                <!-- Sidebar Tabs -->
                <div class="flex border-b border-slate-800">
                    <button onclick="switchTab('chat')" id="tab-chat" class="flex-1 py-3 text-xs font-bold uppercase tracking-wide text-blue-400 border-b-2 border-blue-500 bg-slate-800/50">
                        Chat
                    </button>
                    <button onclick="switchTab('users')" id="tab-users" class="flex-1 py-3 text-xs font-bold uppercase tracking-wide text-slate-400 hover:text-slate-200 border-b-2 border-transparent transition">
                        Info
                    </button>
                </div>

                <!-- Chat View -->
                <div id="view-chat" class="flex-1 flex flex-col overflow-hidden">
                    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <!-- Chat items go here -->
                        <div class="flex justify-center my-2">
                             <span class="text-[10px] bg-slate-800/50 text-slate-500 px-2 py-0.5 rounded-full border border-slate-800">Room Created</span>
                        </div>
                    </div>
                    
                    <!-- AI Suggestion Chips -->
                    <div id="ai-chips" class="px-3 pb-2 flex gap-2 overflow-x-auto hidden">
                        <button onclick="askAI('Suggest a sci-fi movie')" class="whitespace-nowrap bg-purple-900/30 border border-purple-500/30 text-purple-300 text-[10px] px-2 py-1 rounded-full hover:bg-purple-900/50 transition">‚ú® Movie Idea</button>
                        <button onclick="askAI('Tell me a fun fact about this film')" class="whitespace-nowrap bg-purple-900/30 border border-purple-500/30 text-purple-300 text-[10px] px-2 py-1 rounded-full hover:bg-purple-900/50 transition">‚ú® Fun Fact</button>
                    </div>

                    <div class="p-3 bg-slate-800/30 border-t border-slate-700">
                        <form onsubmit="sendMessage(event)" class="relative">
                            <input id="chat-input" type="text" placeholder="Type or ask @AI..." class="w-full bg-slate-950 border border-slate-700 rounded-lg py-2.5 pl-3 pr-10 text-xs text-white focus:border-blue-500 outline-none transition shadow-inner">
                            <button type="submit" class="absolute right-1.5 top-1.5 p-1.5 text-slate-400 hover:text-blue-500 transition">
                                <i data-lucide="send-horizontal" class="w-4 h-4"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Info/Users View -->
                <div id="view-users" class="flex-1 hidden overflow-y-auto p-4">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-4">Room Info</h3>
                    <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700/50 mb-4">
                        <p class="text-xs text-slate-400 mb-1">Invite Link:</p>
                        <div class="flex items-center gap-2 bg-slate-900 p-2 rounded border border-slate-700">
                            <input type="text" id="share-link-input" readonly class="bg-transparent text-[10px] text-white w-full outline-none font-mono">
                            <button onclick="copyRoomLink()" class="text-blue-400 hover:text-white"><i data-lucide="copy" class="w-3 h-3"></i></button>
                        </div>
                    </div>

                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-4">AI Assistant</h3>
                    <div class="bg-gradient-to-br from-purple-900/20 to-blue-900/20 p-3 rounded-lg border border-purple-500/20">
                        <div class="flex items-center gap-2 mb-2">
                             <div class="w-6 h-6 rounded-full bg-gradient-to-tr from-purple-500 to-blue-500 flex items-center justify-center text-xs">‚ú®</div>
                             <span class="text-xs font-bold text-white">Gemini AI Active</span>
                        </div>
                        <p class="text-[10px] text-slate-400">Type <strong>@ai</strong> followed by your question in the chat to get instant movie recommendations or trivia.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // --- FIREBASE SETUP ---
        const firebaseConfig = JSON.parse(__firebase_config); // Provided by environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-zg-app';
        
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion } = window.firebaseModules;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const apiKey = ""; // Runtime provided

        // --- STATE ---
        const state = {
            user: { uid: null, name: 'Guest', avatar: 'üëæ', color: 'bg-blue-600', isHost: false },
            room: 'lobby',
            isConnected: false,
            mediaStream: null,
            videoSource: null,
            ytPlayer: null,
            settings: { hostOnly: false },
            unsubscribeRoom: null,
            lastSeek: 0,
            playbackSpeed: 1.0,
            videoUrl: null,
            videoId: null
        };

        // --- INIT ---
        window.onload = async () => {
            lucide.createIcons();
            loadProfile();
            
            // Check URL for room
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('room')) document.getElementById('room-input').value = urlParams.get('room');
            
            // Auth anonymously first
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth failed", e);
            }
        };

        // --- LOGIN & PROFILE ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            const username = document.getElementById('username-input').value.trim();
            const room = document.getElementById('room-input').value.trim() || 'default-room';
            const avatar = document.getElementById('selected-avatar').value;
            const color = document.getElementById('selected-color').value;

            if(!username) return;

            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('login-loader').classList.remove('hidden');

            state.user.name = username;
            state.user.avatar = avatar;
            state.user.color = color;
            state.room = room;
            state.user.uid = auth.currentUser ? auth.currentUser.uid : 'anon-' + Math.random();

            // Persist
            localStorage.setItem('zg_profile', JSON.stringify({ name: username, avatar, color }));

            // Connect to Room
            await joinRoom(room);

            // UI
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            updateUIProfile();
            
            toast(`Joined ${room}`, 'success');
            await initWebcam();
            initYouTubeAPI();
        };

        // --- FIREBASE SYNC CORE ---
        async function joinRoom(roomId) {
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
            
            // Initial check/create
            try {
                const snap = await getDoc(roomRef);
                if (!snap.exists()) {
                    await setDoc(roomRef, {
                        createdAt: Date.now(),
                        host: state.user.uid,
                        video: { type: null, id: null, url: null, status: 'paused', time: 0, speed: 1.0, lastUpdate: Date.now() },
                        chat: [],
                        settings: { hostOnly: false }
                    });
                    state.user.isHost = true;
                    // Add system message via broadcastChat (requires setup, skipping for brevity in init)
                } else {
                    if(snap.data().host === state.user.uid) state.user.isHost = true;
                }
            } catch(e) { console.error("Room init error", e); }

            // Listen for changes
            state.unsubscribeRoom = onSnapshot(roomRef, (docSnap) => {
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    handleRoomUpdate(data);
                    updateConnectionStatus(true);
                }
            }, (error) => {
                console.error("Sync error:", error);
                updateConnectionStatus(false);
            });
        }

        function handleRoomUpdate(data) {
            // 1. Settings
            if(data.settings) state.settings = data.settings;
            
            // 2. Chat Sync
            if(data.chat && data.chat.length > 0) {
                renderChat(data.chat);
            }

            // 3. Video Sync
            if(data.video) {
                const v = data.video;
                
                // Speed Sync
                if(v.speed && v.speed !== state.playbackSpeed) {
                    document.getElementById('speed-select').value = v.speed;
                    applySpeed(v.speed, true); // true = remote update
                }

                // Change Source?
                if (v.type && (v.type !== state.videoSource || (v.type === 'youtube' && v.id !== state.videoId) || (v.type === 'direct' && v.url !== state.videoUrl))) {
                    if (v.type === 'youtube') {
                         document.getElementById('url-input').value = `https://youtu.be/${v.id}`;
                         state.videoId = v.id;
                         loadFromURL(true); 
                    } else if (v.type === 'direct') {
                         document.getElementById('url-input').value = v.url;
                         state.videoUrl = v.url;
                         loadFromURL(true);
                    }
                }

                // Playback State Drift Calculation (Updated for Speed)
                let targetTime = v.time;
                if(v.status === 'playing') {
                    const elapsed = (Date.now() - v.lastUpdate) / 1000;
                    targetTime += elapsed * v.speed; // Account for speed
                }

                syncPlayer(v.status, targetTime);
            }
        }

        function syncPlayer(status, time) {
            const threshold = 1.0; 

            // YouTube
            if (state.videoSource === 'youtube' && state.ytPlayer && state.ytPlayer.getPlayerState) {
                const currentT = state.ytPlayer.getCurrentTime();
                const diff = Math.abs(currentT - time);
                
                if (diff > threshold) {
                    state.ytPlayer.seekTo(time);
                }
                
                const playerState = state.ytPlayer.getPlayerState(); // 1=playing, 2=paused
                if(status === 'playing' && playerState !== 1) state.ytPlayer.playVideo();
                if(status === 'paused' && playerState !== 2) state.ytPlayer.pauseVideo();
            }
            
            // HTML5
            if (state.videoSource === 'file' || state.videoSource === 'direct') {
                const v = document.getElementById('html5-player');
                // Ensure metadata loaded
                if (v.readyState > 0) {
                    const diff = Math.abs(v.currentTime - time);
                    if (diff > threshold) v.currentTime = time;
                    
                    if (status === 'playing' && v.paused) v.play().catch(e=>{ console.log("Autoplay block", e); });
                    if (status === 'paused' && !v.paused) v.pause();
                }
            }
            
            // Update UI Indicator
            const ind = document.getElementById('sync-indicator');
            const txt = document.getElementById('sync-text');
            if(status === 'playing') { ind.className='w-2 h-2 rounded-full bg-emerald-500 animate-pulse'; txt.innerText='Playing'; }
            else { ind.className='w-2 h-2 rounded-full bg-amber-500'; txt.innerText='Paused'; }
        }

        // --- ACTIONS & BROADCASTS ---
        
        window.changeSpeed = async (val) => {
             const speed = parseFloat(val);
             applySpeed(speed, false);
             
             // Broadcast
             if(state.settings.hostOnly && !state.user.isHost) return;
             const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', state.room);
             await updateDoc(roomRef, {
                 'video.speed': speed,
                 'video.lastUpdate': Date.now()
             });
        };

        function applySpeed(speed, isRemote) {
            state.playbackSpeed = speed;
            const h5 = document.getElementById('html5-player');
            h5.playbackRate = speed;
            if(state.ytPlayer && state.ytPlayer.setPlaybackRate) {
                state.ytPlayer.setPlaybackRate(speed);
            }
            if(isRemote) window.toast(`Speed synced to ${speed}x`, 'info');
        }

        window.broadcastVideoUpdate = async (status, time) => {
            if(state.settings.hostOnly && !state.user.isHost) return;

            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', state.room);
            await updateDoc(roomRef, {
                'video.status': status,
                'video.time': time,
                'video.speed': state.playbackSpeed,
                'video.lastUpdate': Date.now()
            });
        };

        window.broadcastSourceChange = async (type, id, url) => {
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', state.room);
            await updateDoc(roomRef, {
                'video.type': type,
                'video.id': id || null,
                'video.url': url || null,
                'video.status': 'paused',
                'video.time': 0,
                'video.speed': 1.0,
                'video.lastUpdate': Date.now()
            });
            // Reset local speed UI
            document.getElementById('speed-select').value = "1";
            state.playbackSpeed = 1.0;
        };

        window.broadcastChat = async (msgObj) => {
             const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', state.room);
             await updateDoc(roomRef, {
                 chat: arrayUnion(msgObj)
             });
        };

        window.saveSettings = async () => {
            // Profile
            const username = document.getElementById('setting-username').value;
            if(username) {
                state.user.name = username;
                localStorage.setItem('zg_profile', JSON.stringify({ name: username, avatar: state.user.avatar, color: state.user.color }));
                updateUIProfile();
            }
            
            // Room
            const rName = document.getElementById('setting-room-name').value;
            if(rName && state.user.isHost) {
                 document.getElementById('current-room-display').innerText = rName;
            }

            // Permissions
            if(state.user.isHost) {
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', state.room);
                await updateDoc(roomRef, { 'settings.hostOnly': state.settings.hostOnly });
            }

            window.toggleSettings();
            window.toast("Saved!", "success");
        };

        // --- SUBTITLES ---
        window.triggerSubtitleSelect = () => document.getElementById('subtitle-input').click();
        
        window.handleSubtitle = (input) => {
            const file = input.files[0];
            if(!file) return;

            if(state.videoSource === 'youtube') {
                window.toast("Subtitles not supported on YouTube embeds", "error");
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                let content = e.target.result;
                // Simple SRT to WebVTT conversion if needed
                if(file.name.endsWith('.srt')) {
                     content = "WEBVTT\n\n" + content.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g, '$1.$2');
                }
                
                const blob = new Blob([content], {type: 'text/vtt'});
                const url = URL.createObjectURL(blob);
                
                const track = document.getElementById('player-track');
                track.src = url;
                
                // Force track update
                const video = document.getElementById('html5-player');
                video.textTracks[0].mode = 'showing';
                
                window.toast("Subtitles Loaded", "success");
            };
            reader.readAsText(file);
        };

        // --- PLAYER LOGIC ---
        
        window.loadFromURL = (isRemote = false) => {
            const url = document.getElementById('url-input').value.trim();
            if(!url) return;

            // Extract ID
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            const ytId = (match && match[2].length === 11) ? match[2] : null;

            if (ytId) {
                window.activatePlayer('youtube');
                if(!state.ytPlayer) {
                    state.ytPlayer = new YT.Player('youtube-player', {
                        height: '100%',
                        width: '100%',
                        videoId: ytId,
                        playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0 }, // Removed controls for better custom UI sync
                        events: { 
                            'onStateChange': onPlayerStateChange 
                        }
                    });
                } else {
                    state.ytPlayer.loadVideoById(ytId);
                }
                if(!isRemote) window.broadcastSourceChange('youtube', ytId, null);
            } else if (url.match(/\.(mp4|webm|ogg|mov)$/i)) {
                window.activatePlayer('file');
                const v = document.getElementById('html5-player');
                v.src = url;
                if(!isRemote) window.broadcastSourceChange('direct', null, url);
                
                setupVideoListeners(v);
            }
        };

        function setupVideoListeners(v) {
             v.onplay = () => window.broadcastVideoUpdate('playing', v.currentTime);
             v.onpause = () => window.broadcastVideoUpdate('paused', v.currentTime);
             v.onseeked = () => window.broadcastVideoUpdate('playing', v.currentTime);
             v.onratechange = () => {
                 // Check if local change matches state, if not, it might be user interaction
                 // However, we handle speed via dropdown to avoid loops.
             };
        }

        window.onPlayerStateChange = (event) => {
            // YT Events
            if (event.data == YT.PlayerState.PLAYING) window.broadcastVideoUpdate('playing', state.ytPlayer.getCurrentTime());
            else if (event.data == YT.PlayerState.PAUSED) window.broadcastVideoUpdate('paused', state.ytPlayer.getCurrentTime());
        };

        window.activatePlayer = (type) => {
            document.getElementById('placeholder-screen').classList.add('hidden');
            const yt = document.getElementById('youtube-player');
            const h5 = document.getElementById('html5-player');
            state.videoSource = type;
            if(type === 'youtube') { h5.classList.add('hidden'); h5.pause(); yt.style.display = 'block'; }
            else { yt.style.display = 'none'; if(state.ytPlayer?.pauseVideo) state.ytPlayer.pauseVideo(); h5.classList.remove('hidden'); }
        };

        window.handleLocalFile = (input) => {
             const f = input.files[0]; if(!f) return;
             const url = URL.createObjectURL(f);
             
             window.activatePlayer('file');
             const v = document.getElementById('html5-player');
             v.src = url;
             
             window.toast("Local file loaded (Time/Speed synced)", "info");
             
             // Broadcast "file" type so others know to expect a local file or generic player state
             // We don't send the blob URL as it's local only.
             window.broadcastSourceChange('file', null, null); 
             setupVideoListeners(v);
        };

        // --- AI INTEGRATION (unchanged) ---
        window.askAI = async (query) => {
            const prompt = query || document.getElementById('chat-input').value.replace('@ai', '').trim();
            if(!prompt) return;

            const userMsg = { user: state.user.name, msg: prompt, avatar: state.user.avatar, color: state.user.color, timestamp: Date.now() };
            window.broadcastChat(userMsg);
            
            window.toast("AI is thinking...", "info");

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: "You are a movie companion in a watch party. Keep it short and fun. Answer: " + prompt }] }] })
                });
                
                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I fell asleep during the movie.";

                const aiMsg = { user: 'AI Assistant', msg: aiText, avatar: '‚ú®', color: 'bg-purple-600', timestamp: Date.now() };
                window.broadcastChat(aiMsg);
                
            } catch (err) {
                console.error(err);
                window.toast("AI Error", "error");
            }

            document.getElementById('chat-input').value = '';
        };

        // --- CHAT RENDER (unchanged) ---
        function renderChat(messages) {
            const container = document.getElementById('chat-container');
            container.innerHTML = ''; 
            
            messages.forEach(m => {
                const isMe = m.user === state.user.name;
                const isAI = m.user === 'AI Assistant';
                const div = document.createElement('div');
                div.className = `flex gap-2 ${isMe ? 'flex-row-reverse' : 'flex-row'} animate-fade`;
                
                const bubbleColor = isMe ? state.user.color : (isAI ? 'bg-gradient-to-r from-purple-600 to-blue-600 border border-purple-400' : 'bg-slate-800');
                const glow = isAI ? 'ai-glow' : '';

                div.innerHTML = `
                    <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs shrink-0 ${isMe ? 'bg-slate-700' : 'bg-slate-800'}">${m.avatar || '?'}</div>
                    <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[85%]">
                        <span class="text-[9px] text-slate-500 mb-0.5 px-1">${m.user}</span>
                        <div class="${bubbleColor} text-white px-3 py-2 rounded-xl text-xs leading-relaxed shadow-sm ${glow}">
                            ${m.msg}
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        // --- UTILITIES (unchanged) ---
        window.sendMessage = (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;

            if(msg.toLowerCase().startsWith('@ai')) {
                window.askAI();
            } else {
                const msgObj = {
                    user: state.user.name,
                    msg: msg,
                    avatar: state.user.avatar,
                    color: state.user.color,
                    timestamp: Date.now()
                };
                window.broadcastChat(msgObj);
                input.value = '';
            }
        };
        
        window.generateRoomId = () => {
             document.getElementById('room-input').value = Math.random().toString(36).substring(2, 8);
        };
        
        window.selectAvatar = (av, col) => {
            state.user.avatar = av;
            state.user.color = col;
            document.getElementById('selected-avatar').value = av;
            document.getElementById('selected-color').value = col;
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
        };
        
        window.loadProfile = () => {
            const s = localStorage.getItem('zg_profile');
            if(s) {
                const p = JSON.parse(s);
                document.getElementById('username-input').value = p.name;
                document.getElementById('setting-username').value = p.name;
                state.user.avatar = p.avatar;
                state.user.color = p.color;
            }
        };
        
        window.updateUIProfile = () => {
            document.getElementById('current-room-display').innerText = state.room;
            document.getElementById('share-link-input').value = window.location.href.split('?')[0] + '?room=' + state.room;
            document.getElementById('user-avatar-display').innerText = state.user.avatar;
            document.getElementById('user-avatar-display').className = `w-9 h-9 rounded-full ${state.user.color} border border-slate-600 flex items-center justify-center text-white font-bold text-lg shadow-inner cursor-pointer`;
            document.getElementById('cam-label-name').innerText = state.user.name;
            
            document.getElementById('modal-avatar-preview').innerText = state.user.avatar;
            document.getElementById('modal-avatar-preview').className = `w-12 h-12 rounded-full ${state.user.color} flex items-center justify-center text-2xl border border-slate-600`;
            document.getElementById('setting-username').value = state.user.name;
        };
        
        window.updateModalAvatar = (av) => {
             state.user.avatar = av;
             updateUIProfile();
        };

        window.toggleSettings = () => {
            const modal = document.getElementById('settings-modal');
            if(modal.open) modal.close(); else modal.showModal();
        };
        
        window.toggleHostMode = () => {
             state.settings.hostOnly = !state.settings.hostOnly;
             const btn = document.getElementById('toggle-host-only');
             const knob = btn.firstElementChild;
             if(state.settings.hostOnly) {
                 btn.classList.add('bg-blue-600'); btn.classList.remove('bg-slate-700'); knob.classList.add('translate-x-5');
             } else {
                 btn.classList.remove('bg-blue-600'); btn.classList.add('bg-slate-700'); knob.classList.remove('translate-x-5');
             }
        };
        
        window.switchTab = (tab) => {
            if(tab === 'chat') {
                document.getElementById('view-chat').classList.remove('hidden');
                document.getElementById('view-users').classList.add('hidden');
                document.getElementById('ai-chips').classList.remove('hidden');
                document.getElementById('tab-chat').classList.add('border-blue-500', 'text-blue-400');
                document.getElementById('tab-users').classList.remove('border-blue-500', 'text-blue-400');
            } else {
                document.getElementById('view-chat').classList.add('hidden');
                document.getElementById('view-users').classList.remove('hidden');
                document.getElementById('ai-chips').classList.add('hidden');
                document.getElementById('tab-users').classList.add('border-blue-500', 'text-blue-400');
                document.getElementById('tab-chat').classList.remove('border-blue-500', 'text-blue-400');
            }
        };

        window.initYouTubeAPI = () => {
            if(!window.YT) {
                const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
                const first = document.getElementsByTagName('script')[0]; first.parentNode.insertBefore(tag, first);
            }
        };
        
        window.updateConnectionStatus = (online) => {
            const el = document.getElementById('connection-status');
            if(online) {
                el.innerHTML = `<div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div> Live Sync`;
                el.classList.replace('text-slate-400', 'text-emerald-400');
            } else {
                el.innerHTML = `<div class="w-2 h-2 rounded-full bg-red-500"></div> Reconnecting...`;
                el.classList.replace('text-emerald-400', 'text-slate-400');
            }
        };
        
        window.copyRoomLink = () => {
             const url = window.location.origin + window.location.pathname + '?room=' + state.room;
             navigator.clipboard.writeText(url).then(()=>window.toast('Copied!', 'success')).catch(()=>prompt("Link:", url));
        };
        
        window.leaveRoom = () => location.reload();
        
        window.toast = (msg, type='info') => {
             const c = document.getElementById('toast-container');
             const d = document.createElement('div');
             let cl = 'bg-slate-800 border-slate-600';
             if(type=='success') cl = 'bg-emerald-600/90 border-emerald-500';
             if(type=='error') cl = 'bg-red-500/90 border-red-500';
             d.className = `${cl} text-white border px-4 py-2 rounded-lg text-xs font-bold shadow-xl backdrop-blur-md flex items-center gap-2 toast-enter`;
             d.innerText = msg;
             c.appendChild(d);
             setTimeout(()=>d.remove(), 3000);
        };
        
        window.triggerFileSelect = () => document.getElementById('local-file-input').click();
        
        window.initWebcam = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                document.getElementById('my-webcam').srcObject = stream;
                state.mediaStream = stream;
            } catch(e) { document.getElementById('cam-off-indicator').classList.remove('hidden'); }
        };
        
        window.toggleCam = () => {
             if(!state.mediaStream) return;
             const t = state.mediaStream.getVideoTracks()[0]; t.enabled = !t.enabled;
             const ind = document.getElementById('cam-off-indicator');
             const btn = document.getElementById('btn-cam');
             if(t.enabled) { ind.classList.add('hidden'); btn.classList.replace('bg-red-500', 'bg-slate-700'); }
             else { ind.classList.remove('hidden'); btn.classList.replace('bg-slate-700', 'bg-red-500'); }
        };
        
        window.toggleMic = () => {
             if(!state.mediaStream) return;
             const t = state.mediaStream.getAudioTracks()[0]; t.enabled = !t.enabled;
             const btn = document.getElementById('btn-mic');
             if(t.enabled) btn.classList.replace('bg-red-500', 'bg-slate-700'); else btn.classList.replace('bg-slate-700', 'bg-red-500');
        };

    </script>
</body>
</html>
