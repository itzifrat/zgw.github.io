<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NearWatch | P2P Encrypted</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Use the CDN version that's known to work -->
    <script>
        // We load PeerJS dynamically so we can try multiple CDNs
        window.PEERJS_LOADED = false;
    </script>
    <style>
        :root { --bg-dark: #0b0e14; --primary: #6366f1; --surface: #151923; }
        body { background-color: var(--bg-dark); color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        .video-wrapper { width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#000; }
        .video-container { position:relative; width:100%; max-width:100%; aspect-ratio:16/9; max-height:80vh; background:black; overflow:hidden; box-shadow:0 20px 25px -5px rgba(0,0,0,.5); }
        .video-container iframe, .video-container video { position:absolute; top:0; left:0; width:100%; height:100%; outline:none; }
        .fade-in { animation: fadeIn .5s ease-out; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        .toast-enter { animation: slideIn .3s ease-out forwards; }
        @keyframes slideIn { from{opacity:0;transform:translateY(-20px) translateX(-50%)} to{opacity:1;transform:translateY(0) translateX(-50%)} }
        .avatar-option { transition:all .2s; cursor:pointer; opacity:.7; transform:scale(.95); }
        .avatar-option:hover { opacity:1; transform:scale(1.05); }
        .avatar-option.selected { opacity:1; transform:scale(1.15); border-color:var(--primary); box-shadow:0 0 15px rgba(99,102,241,.6); }
        ::-webkit-scrollbar { width:4px; }
        ::-webkit-scrollbar-track { background:var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background:#334155; border-radius:2px; }
        .quote-fade { animation:fadeInOut 8s infinite; }
        @keyframes fadeInOut { 0%,100%{opacity:0;transform:translateY(5px)} 10%,90%{opacity:1;transform:translateY(0)} }
        .glass-panel { background:rgba(21,25,35,.85); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,.05); }

        /* Debug panel */
        #debug-panel { font-family: monospace; font-size: 10px; max-height: 80px; overflow-y: auto; }
        #debug-panel .log-ok   { color: #34d399; }
        #debug-panel .log-err  { color: #f87171; }
        #debug-panel .log-info { color: #93c5fd; }

        /* Spinner */
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
    </style>
</head>
<body class="h-screen w-screen relative flex flex-col">

<div id="toast-container" class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none w-max max-w-[90%]"></div>

<!-- Settings Modal -->
<dialog id="settings-modal" class="bg-transparent p-0 backdrop:bg-black/80 backdrop:backdrop-blur-sm w-full max-w-md m-auto">
    <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl p-6 text-white mx-4">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5 text-indigo-400"></i> Settings</h2>
            <button onclick="toggleSettings()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="space-y-6">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-3">Profile</label>
                <div class="flex items-center gap-4 mb-4">
                    <div id="modal-avatar-preview" class="w-16 h-16 rounded-full flex items-center justify-center text-3xl shadow-lg border-2 border-slate-700 transition-all bg-indigo-600"></div>
                    <div class="flex-1">
                        <input type="text" id="modal-username" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 outline-none mb-2" placeholder="Display Name">
                        <div class="text-[10px] text-slate-500">Pick an avatar:</div>
                    </div>
                </div>
                <div class="grid grid-cols-5 gap-2 p-2 bg-slate-800/50 rounded-xl border border-slate-700/50">
                    <button onclick="selectModalAvatar('üëæ','bg-indigo-600')" class="h-10 w-10 rounded-full bg-indigo-600 flex items-center justify-center hover:scale-110 transition mx-auto text-lg">üëæ</button>
                    <button onclick="selectModalAvatar('üê±','bg-purple-600')" class="h-10 w-10 rounded-full bg-purple-600 flex items-center justify-center hover:scale-110 transition mx-auto text-lg">üê±</button>
                    <button onclick="selectModalAvatar('ü§ñ','bg-emerald-600')" class="h-10 w-10 rounded-full bg-emerald-600 flex items-center justify-center hover:scale-110 transition mx-auto text-lg">ü§ñ</button>
                    <button onclick="selectModalAvatar('ü¶ä','bg-orange-600')" class="h-10 w-10 rounded-full bg-orange-600 flex items-center justify-center hover:scale-110 transition mx-auto text-lg">ü¶ä</button>
                    <button onclick="selectModalAvatar('üëª','bg-pink-600')" class="h-10 w-10 rounded-full bg-pink-600 flex items-center justify-center hover:scale-110 transition mx-auto text-lg">üëª</button>
                </div>
            </div>
            <div id="host-settings-group" class="hidden space-y-4 pt-4 border-t border-slate-800">
                <div class="p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-3">Room Security</label>
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm">Lock Room</span>
                        <button id="btn-lock-room" onclick="toggleRoomLock()" class="w-10 h-5 rounded-full bg-slate-700 relative transition-colors"><div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform"></div></button>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Host-Only Controls</span>
                        <button id="btn-host-only" onclick="toggleHostOnly()" class="w-10 h-5 rounded-full bg-slate-700 relative transition-colors"><div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform"></div></button>
                    </div>
                </div>
            </div>
            <div class="pt-2">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">AI Integration</label>
                <div class="relative">
                    <input type="password" id="ai-api-key" placeholder="Paste Gemini API Key" class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-3 pr-8 py-2 text-xs focus:border-purple-500 outline-none">
                    <i data-lucide="key" class="absolute right-2 top-2 w-3.5 h-3.5 text-slate-500"></i>
                </div>
            </div>
            <button onclick="saveSettings()" class="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-lg font-bold text-sm shadow-lg transition-colors">Save Changes</button>
            <div class="pt-4 border-t border-slate-700 text-center">
                <p class="text-[10px] text-slate-500">NearWatch v3.0 ‚Ä¢ P2P Encrypted</p>
                <p class="text-[10px] text-slate-600 font-medium mt-1">Copyright ¬© Efrat Al Ahad</p>
            </div>
        </div>
    </div>
</dialog>

<!-- Login View -->
<div id="login-view" class="absolute inset-0 z-50 flex items-center justify-center bg-[#0b0e14] bg-[url('https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80&w=2525&auto=format&fit=crop')] bg-cover bg-center">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>

    <div class="relative glass-panel p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4 fade-in">
        <div class="text-center mb-6">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 w-14 h-14 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-500/20">
                <i data-lucide="monitor-play" class="text-white w-7 h-7"></i>
            </div>
            <h1 class="text-2xl font-bold text-white tracking-tight mb-2">NearWatch</h1>
            <div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-[10px] font-bold uppercase tracking-wider">
                <i data-lucide="shield-check" class="w-3 h-3"></i><span>P2P Encrypted</span>
            </div>
        </div>

        <!-- Avatar Selector -->
        <div class="flex justify-center gap-4 mb-6">
            <div class="avatar-option w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-lg border-2 border-transparent shadow-lg" onclick="selectAvatar('üëæ','bg-indigo-600')">üëæ</div>
            <div class="avatar-option w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center text-lg border-2 border-transparent shadow-lg" onclick="selectAvatar('üê±','bg-purple-600')">üê±</div>
            <div class="avatar-option w-10 h-10 rounded-full bg-emerald-600 flex items-center justify-center text-lg border-2 border-transparent shadow-lg" onclick="selectAvatar('ü§ñ','bg-emerald-600')">ü§ñ</div>
            <div class="avatar-option w-10 h-10 rounded-full bg-orange-600 flex items-center justify-center text-lg border-2 border-transparent shadow-lg" onclick="selectAvatar('ü¶ä','bg-orange-600')">ü¶ä</div>
        </div>

        <div class="space-y-4">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="user" class="h-4 w-4 text-slate-500"></i></div>
                <input type="text" id="username-input" placeholder="Display Name" class="w-full bg-[#0f1218] border border-slate-700 rounded-xl pl-10 pr-4 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition text-sm placeholder-slate-500">
            </div>

            <div class="grid grid-cols-2 gap-1 p-1 bg-[#0f1218] rounded-xl border border-slate-800">
                <button onclick="switchMode('create')" id="btn-mode-create" class="py-2 text-xs font-bold rounded-lg transition-all bg-indigo-600 text-white shadow-lg">Create Room</button>
                <button onclick="switchMode('join')" id="btn-mode-join" class="py-2 text-xs font-bold rounded-lg transition-all text-slate-400 hover:text-white">Join Room</button>
            </div>

            <div id="create-input-group">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="key" class="h-4 w-4 text-slate-500"></i></div>
                    <input type="text" id="create-id-input" placeholder="Room ID (leave blank = random)" class="w-full bg-[#0f1218] border border-slate-700 rounded-xl pl-10 pr-12 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition text-sm placeholder-slate-500">
                    <button onclick="fillRandomId()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-500 hover:text-indigo-400" title="Random ID"><i data-lucide="dices" class="h-5 w-5"></i></button>
                </div>
            </div>

            <div id="join-input-group" class="hidden">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="link" class="h-4 w-4 text-slate-500"></i></div>
                    <input type="text" id="join-id-input" placeholder="Enter Room ID" class="w-full bg-[#0f1218] border border-slate-700 rounded-xl pl-10 pr-4 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition text-sm placeholder-slate-500">
                </div>
            </div>

            <!-- Status area -->
            <div id="status-box" class="hidden bg-[#0f1218] border border-slate-800 rounded-xl p-3">
                <div class="flex items-center gap-2 mb-2">
                    <svg id="status-spinner" class="spin w-3 h-3 text-indigo-400 hidden" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" stroke-dasharray="31.4" stroke-dashoffset="10"/></svg>
                    <span id="status-msg" class="text-xs text-slate-400"></span>
                </div>
                <div id="debug-panel"></div>
            </div>

            <button onclick="handleStart()" id="action-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg transition transform active:scale-[0.98] text-sm uppercase tracking-wide flex items-center justify-center gap-2">
                Create Room
            </button>
            <button onclick="handleStart()" id="retry-btn" class="hidden w-full bg-slate-800 hover:bg-slate-700 border border-slate-600 text-white font-bold py-2.5 rounded-xl transition text-sm flex items-center justify-center gap-2">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Retry Connection
            </button>
        </div>
    </div>
</div>

<!-- App View -->
<div id="app-view" class="flex flex-col h-full hidden bg-[#0b0e14]">
    <header class="h-14 border-b border-slate-800 flex items-center justify-between px-4 z-20 shrink-0 bg-[#0b0e14]">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 p-1.5 rounded-lg"><i data-lucide="monitor-play" class="text-white w-4 h-4"></i></div>
            <h1 class="hidden sm:block font-bold text-white text-sm tracking-tight">NearWatch</h1>
        </div>
        <div class="flex items-center gap-2 bg-[#151923] border border-slate-800 rounded-full px-3 py-1">
            <span id="sync-dot" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
            <p class="text-[10px] text-slate-400 cursor-pointer hover:text-indigo-400 transition flex items-center gap-2" onclick="copyId()">
                <span id="my-peer-id" class="font-mono max-w-[80px] sm:max-w-[150px] truncate">...</span>
                <i data-lucide="copy" class="w-3 h-3"></i>
            </p>
            <div id="room-locked-indicator" class="hidden"><i data-lucide="lock" class="w-3 h-3 text-red-400"></i></div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleMobileChat()" class="lg:hidden text-slate-400 hover:text-white p-2 relative">
                <i data-lucide="message-square" class="w-5 h-5"></i>
                <span id="chat-badge" class="absolute top-1 right-1 w-2 h-2 bg-indigo-500 rounded-full hidden"></span>
            </button>
            <button onclick="toggleSettings()" class="text-slate-400 hover:text-white transition"><i data-lucide="settings" class="w-5 h-5"></i></button>
            <div id="user-avatar-display" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center font-bold text-sm shadow-inner cursor-pointer" onclick="toggleSettings()">?</div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        <div class="flex-1 flex flex-col bg-black relative w-full h-full">
            <div class="absolute top-4 left-1/2 -translate-x-1/2 w-[95%] max-w-2xl z-20 opacity-0 hover:opacity-100 transition duration-300">
                <div class="flex flex-wrap justify-center gap-2 bg-[#151923]/90 backdrop-blur p-1.5 rounded-xl border border-slate-700 shadow-2xl">
                    <div class="flex items-center flex-1 min-w-[150px] gap-2">
                        <input type="text" id="url-input" placeholder="YouTube / MP4 URL" class="bg-transparent border-none text-xs w-full text-white focus:ring-0 outline-none pl-2">
                        <button onclick="loadVideo()" class="bg-indigo-600 hover:bg-indigo-500 px-3 py-1.5 rounded-lg text-xs font-bold text-white transition">Play</button>
                    </div>
                    <div class="w-px h-6 bg-slate-700 hidden sm:block"></div>
                    <button onclick="document.getElementById('file-input').click()" class="flex items-center gap-2 bg-[#1f2937] hover:bg-slate-700 px-3 py-1.5 rounded-lg text-xs text-white border border-slate-700 transition">
                        <i data-lucide="file-video" class="w-3 h-3 text-emerald-500"></i><span class="hidden sm:inline">File</span>
                    </button>
                    <input type="file" id="file-input" class="hidden" accept="video/*" onchange="handleFile(this)">
                </div>
            </div>
            <div class="flex-1 overflow-hidden bg-[#000] flex flex-col justify-center items-center">
                <div class="video-wrapper">
                    <div id="video-box" class="video-container">
                        <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-[#0b0e14] z-10">
                            <i data-lucide="film" class="w-16 h-16 mb-4 opacity-20"></i>
                            <h3 class="text-lg font-bold text-white mb-1">Ready?</h3>
                            <p class="text-xs text-slate-500">Paste a link or load a file above</p>
                        </div>
                        <video id="html5-player" class="hidden" controls playsinline crossorigin="anonymous">
                            <track id="player-track" kind="subtitles" srclang="en" label="English" default>
                        </video>
                        <div id="youtube-player" class="hidden"></div>
                    </div>
                </div>
            </div>
            <div class="w-full bg-[#151923] border-t border-slate-800 px-4 py-3 flex items-center justify-between shrink-0 z-20">
                <div class="flex items-center gap-4">
                    <button onclick="seekRelative(-10)" class="text-slate-400 hover:text-white transition"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button>
                    <button onclick="seekRelative(10)" class="text-slate-400 hover:text-white transition"><i data-lucide="rotate-cw" class="w-5 h-5"></i></button>
                    <div class="relative">
                        <select id="speed-select" onchange="changeSpeed(this.value)" class="bg-[#0b0e14] text-slate-300 text-xs border border-slate-700 rounded px-2 py-1 outline-none appearance-none pr-6 cursor-pointer">
                            <option value="0.5">0.5x</option><option value="1" selected>1.0x</option>
                            <option value="1.25">1.25x</option><option value="1.5">1.5x</option><option value="2">2.0x</option>
                        </select>
                        <i data-lucide="chevron-down" class="w-3 h-3 text-slate-500 absolute right-1.5 top-1.5 pointer-events-none"></i>
                    </div>
                    <button onclick="document.getElementById('sub-input').click()" class="text-slate-400 hover:text-white transition"><i data-lucide="captions" class="w-5 h-5"></i></button>
                    <input type="file" id="sub-input" accept=".vtt,.srt" class="hidden" onchange="handleSubtitle(this)">
                </div>
                <p id="quote-text" class="hidden md:block text-xs text-slate-500 italic truncate max-w-[400px] quote-fade text-center">Watch together. No limits.</p>
                <button onclick="toggleFullscreen()" class="text-slate-400 hover:text-white transition"><i data-lucide="maximize" class="w-5 h-5"></i></button>
            </div>
        </div>

        <div id="chat-sidebar" class="fixed inset-y-0 right-0 z-30 w-80 bg-[#151923] border-l border-slate-800 flex flex-col transition-transform duration-300 transform translate-x-full lg:translate-x-0 lg:static">
            <button onclick="toggleMobileChat()" class="lg:hidden absolute top-3 right-3 p-2 text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="flex border-b border-slate-800 mt-10 lg:mt-0">
                <button onclick="switchTab('chat')" id="tab-chat" class="w-1/2 py-3 text-xs font-bold text-indigo-400 border-b-2 border-indigo-500">Chat</button>
                <button onclick="switchTab('users')" id="tab-users" class="w-1/2 py-3 text-xs font-bold text-slate-500 flex items-center justify-center gap-1">
                    Users <span id="user-count" class="text-[9px] bg-slate-800 px-1.5 py-0.5 rounded-full">1</span>
                </button>
            </div>
            <div id="view-chat" class="flex-1 flex flex-col overflow-hidden bg-[#0b0e14]">
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <div class="text-center text-[10px] text-slate-600 my-4 uppercase tracking-widest font-bold">‚Äî Room Created ‚Äî</div>
                </div>
                <div class="p-3 bg-[#151923] border-t border-slate-800">
                    <div class="flex gap-2 mb-3 overflow-x-auto pb-1">
                        <button onclick="sendEmoji('üëã')" class="text-xl hover:scale-110 transition">üëã</button>
                        <button onclick="sendEmoji('üòÇ')" class="text-xl hover:scale-110 transition">üòÇ</button>
                        <button onclick="sendEmoji('üî•')" class="text-xl hover:scale-110 transition">üî•</button>
                        <button onclick="sendEmoji('üòÆ')" class="text-xl hover:scale-110 transition">üòÆ</button>
                        <button onclick="sendEmoji('‚ù§Ô∏è')" class="text-xl hover:scale-110 transition">‚ù§Ô∏è</button>
                        <div class="w-px h-6 bg-slate-700 mx-1"></div>
                        <button onclick="askAI('Suggest a movie')" class="whitespace-nowrap text-[10px] bg-purple-500/10 text-purple-300 px-2.5 py-1 rounded-full border border-purple-500/20 hover:bg-purple-500/20 transition">‚ú® Idea</button>
                    </div>
                    <form onsubmit="sendChat(event)" class="relative">
                        <input id="chat-input" type="text" placeholder="Type a message..." class="w-full bg-[#0b0e14] border border-slate-700 rounded-xl py-3 pl-4 pr-10 text-xs text-white focus:border-indigo-500 outline-none placeholder-slate-600">
                        <button type="submit" class="absolute right-2 top-2.5 text-slate-400 hover:text-indigo-500"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                    </form>
                </div>
            </div>
            <div id="view-users" class="flex-1 hidden overflow-y-auto p-4 bg-[#0b0e14]">
                <h3 class="text-xs font-bold text-slate-500 uppercase mb-4 tracking-widest">Participants</h3>
                <div id="user-list-container" class="space-y-2"></div>
            </div>
        </div>
    </main>
</div>

<script>
// ================================================================
//  PEERJS LOADER ‚Äî tries multiple CDNs until one works
// ================================================================
const PEERJS_CDNS = [
    'https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js',
    'https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js',
];

function loadScript(src) {
    return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = src; s.onload = res; s.onerror = rej;
        document.head.appendChild(s);
    });
}

async function loadPeerJS() {
    for (const cdn of PEERJS_CDNS) {
        try {
            dbg(`Loading PeerJS from ${cdn.split('/')[2]}...`, 'info');
            await loadScript(cdn);
            if (typeof Peer !== 'undefined') { dbg('PeerJS loaded ‚úì', 'ok'); return true; }
        } catch (e) { dbg(`CDN failed: ${cdn.split('/')[2]}`, 'err'); }
    }
    dbg('All CDNs failed!', 'err');
    return false;
}

// ================================================================
//  PEERJS SERVER CONFIGS ‚Äî ordered by reliability
// ================================================================
// Config 1: PeerJS official cloud (most users work with this)
// Config 2: PeerJS cloud with explicit STUN
// Config 3: Metered.ca free TURN relay (helps with strict NAT/firewalls)
const PEER_SERVER_CONFIGS = [
    {
        // Default PeerJS cloud
        host: '0.peerjs.com', port: 443, path: '/', secure: true,
        config: { iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
        ]}
    },
    {
        // PeerJS cloud alternate path
        host: 'peerjs.com', port: 443, path: '/peerserver', secure: true,
        config: { iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:global.stun.twilio.com:3478' },
        ]}
    },
    {
        // Pure STUN/TURN only (no custom signaling host = uses default peerjs.com)
        config: { iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' },
            // Free open TURN from Open Relay Project
            { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turn:openrelay.metered.ca:443?transport=tcp', username: 'openrelayproject', credential: 'openrelayproject' },
        ]}
    }
];

// ================================================================
//  STATE
// ================================================================
const genId = () => Math.random().toString(36).substring(2, 8);
let peer, connections = [], hostConn = null;
let isSyncing = false, apiKey = '';
let connTimeout = null, serverConfigIdx = 0, retryCount = 0;
const MAX_RETRIES = 3;
let userList = [];
const quotes = ["Watch together. No lag. No limits.","Tonight, we're not alone.","Turn loneliness into togetherness.","Distance shouldn't pause the movie.","Press play. Feel close.","Same screen. Same moment."];

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playPing() {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.type='sine'; o.frequency.setValueAtTime(520,audioCtx.currentTime);
    o.frequency.exponentialRampToValueAtTime(900,audioCtx.currentTime+.1);
    g.gain.setValueAtTime(.08,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.15);
    o.start(); o.stop(audioCtx.currentTime+.15);
}

const state = {
    mode:'create', id:null, username:'Guest', avatar:'üëæ', color:'bg-indigo-600',
    hostOnly:false, isLocked:false, maxUsers:10, isCoHost:false, targetHostId:null,
    video:{ type:null, src:null, time:0, state:'paused', speed:1 }, ytPlayer:null
};

// ================================================================
//  DEBUG PANEL
// ================================================================
function dbg(msg, type='info') {
    console.log(`[NW][${type}] ${msg}`);
    const panel = document.getElementById('debug-panel');
    if (!panel) return;
    const line = document.createElement('div');
    line.className = `log-${type}`;
    line.textContent = `‚Ä∫ ${msg}`;
    panel.appendChild(line);
    panel.scrollTop = panel.scrollHeight;
}

// ================================================================
//  INIT
// ================================================================
window.onload = async () => {
    lucide.createIcons();
    loadProfile();
    startQuotes();
    const p = new URLSearchParams(window.location.search);
    if (p.get('join')) { switchMode('join'); document.getElementById('join-id-input').value = p.get('join'); }

    // Pre-load PeerJS in background
    await loadPeerJS();
};

function startQuotes() {
    let i = 0;
    setInterval(() => {
        i = (i+1) % quotes.length;
        const el = document.getElementById('quote-text');
        if (el) { el.classList.remove('quote-fade'); void el.offsetWidth; el.innerText = quotes[i]; el.classList.add('quote-fade'); }
    }, 8000);
}

function loadProfile() {
    const s = localStorage.getItem('nw_profile');
    if (s) {
        const p = JSON.parse(s);
        document.getElementById('username-input').value = p.name || '';
        document.getElementById('modal-username').value = p.name || '';
        selectAvatar(p.avatar || 'üëæ', p.color || 'bg-indigo-600', true);
        selectModalAvatar(p.avatar || 'üëæ', p.color || 'bg-indigo-600');
        apiKey = p.apiKey || '';
        document.getElementById('ai-api-key').value = apiKey;
    } else {
        selectAvatar('üëæ','bg-indigo-600',true);
        selectModalAvatar('üëæ','bg-indigo-600');
    }
}

// ================================================================
//  LOGIN UI
// ================================================================
function switchMode(m) {
    state.mode = m;
    const bc = document.getElementById('btn-mode-create');
    const bj = document.getElementById('btn-mode-join');
    const ab = document.getElementById('action-btn');
    const on = 'py-2 text-xs font-bold rounded-lg transition-all bg-indigo-600 text-white shadow-lg';
    const off = 'py-2 text-xs font-bold rounded-lg transition-all text-slate-400 hover:text-white hover:bg-slate-800';
    if (m === 'create') {
        bc.className=on; bj.className=off; ab.innerText='Create Room';
        document.getElementById('create-input-group').classList.remove('hidden');
        document.getElementById('join-input-group').classList.add('hidden');
    } else {
        bj.className=on; bc.className=off; ab.innerText='Join Room';
        document.getElementById('create-input-group').classList.add('hidden');
        document.getElementById('join-input-group').classList.remove('hidden');
    }
    lucide.createIcons();
}

function fillRandomId() { document.getElementById('create-id-input').value = genId(); }

function selectAvatar(av, col, isLogin=false) {
    if (isLogin) {
        state.avatar=av; state.color=col;
        document.querySelectorAll('.avatar-option').forEach(el => {
            el.classList.toggle('selected', el.innerText.trim() === av);
        });
    }
}
function selectModalAvatar(av, col) {
    state.avatar=av; state.color=col;
    const p = document.getElementById('modal-avatar-preview');
    p.innerText=av;
    p.className=`w-16 h-16 rounded-full flex items-center justify-center text-3xl shadow-lg border-2 border-slate-700 transition-all ${col}`;
}

function setStatus(msg, type='neutral') {
    document.getElementById('status-box').classList.remove('hidden');
    const el = document.getElementById('status-msg');
    el.innerText = msg;
    el.className = `text-xs ${type==='err'?'text-red-400':type==='ok'?'text-emerald-400':'text-slate-400'}`;
    document.getElementById('status-spinner').classList.toggle('hidden', type==='err'||type==='ok');
    dbg(msg, type==='err'?'err':type==='ok'?'ok':'info');
}

function resetUI(errMsg='') {
    const btn = document.getElementById('action-btn');
    btn.disabled=false;
    btn.innerText = state.mode==='create'?'Create Room':'Join Room';
    document.getElementById('status-spinner').classList.add('hidden');
    if (errMsg) {
        setStatus(errMsg, 'err');
        toast(errMsg, 'error');
        document.getElementById('retry-btn').classList.remove('hidden');
        lucide.createIcons();
    }
}

// ================================================================
//  MAIN ENTRY POINT
// ================================================================
async function handleStart() {
    const name = document.getElementById('username-input').value.trim();
    if (!name) return toast('Enter a display name','error');
    state.username = name;
    localStorage.setItem('nw_profile', JSON.stringify({name, avatar:state.avatar, color:state.color, apiKey}));

    document.getElementById('action-btn').disabled = true;
    document.getElementById('action-btn').innerText = 'Connecting...';
    document.getElementById('retry-btn').classList.add('hidden');
    document.getElementById('debug-panel').innerHTML = '';

    // Make sure PeerJS is loaded
    if (typeof Peer === 'undefined') {
        setStatus('Loading PeerJS library...');
        const ok = await loadPeerJS();
        if (!ok) { resetUI('Failed to load PeerJS. Check your internet.'); return; }
    }

    if (peer) { try { peer.destroy(); } catch(e){} peer=null; }
    connections=[]; hostConn=null; retryCount=0; serverConfigIdx=0;

    if (state.mode === 'create') {
        const inputId = document.getElementById('create-id-input').value.trim().replace(/[^a-zA-Z0-9-_]/g,'');
        state.id = inputId || genId();
        state.isCoHost=true; state.hostOnly=false; state.isLocked=false; state.targetHostId=null;
        initPeer(state.id, null);
    } else {
        const inputId = document.getElementById('join-id-input').value.trim().replace(/[^a-zA-Z0-9-_]/g,'');
        if (!inputId) { resetUI('Enter a Room ID'); return; }
        state.id = genId();
        state.targetHostId = inputId;
        initPeer(state.id, inputId);
    }
}

// ================================================================
//  PEERJS ‚Äî MULTI-CONFIG INIT
// ================================================================
function initPeer(myId, targetHostId) {
    const cfg = PEER_SERVER_CONFIGS[serverConfigIdx];
    setStatus(`Trying server config ${serverConfigIdx+1}/${PEER_SERVER_CONFIGS.length}...`);
    dbg(JSON.stringify({host:cfg.host, port:cfg.port}), 'info');

    try {
        peer = new Peer(myId, { ...cfg, debug: 2 });
    } catch(e) {
        dbg(`Peer() threw: ${e.message}`, 'err');
        tryNextServerConfig(myId, targetHostId, e.message);
        return;
    }

    // Timeout if 'open' never fires
    const openTimeout = setTimeout(() => {
        if (!peer || !peer.open) {
            dbg('open event timeout', 'err');
            tryNextServerConfig(myId, targetHostId, 'Server timeout');
        }
    }, 10000);

    peer.on('open', id => {
        clearTimeout(openTimeout);
        dbg(`Peer open ‚úì  id=${id}`, 'ok');
        setStatus('Connected to signaling server ‚úì', 'ok');

        if (targetHostId) {
            connectToHost(targetHostId);
        } else {
            onHostReady(id);
        }
    });

    peer.on('connection', conn => {
        if (state.mode !== 'create') return;
        if (state.isLocked) { conn.on('open',()=>{ conn.send({type:'error',msg:'Room is Locked.'}); setTimeout(()=>conn.close(),500); }); return; }
        if (connections.length >= state.maxUsers) { conn.on('open',()=>{ conn.send({type:'error',msg:'Room Full.'}); setTimeout(()=>conn.close(),500); }); return; }
        connections.push(conn);
        setupConn(conn);
        setTimeout(()=>{ if(conn.open){ conn.send({type:'sync-full',video:state.video,hostOnly:state.hostOnly,isLocked:state.isLocked}); broadcastUserList(); } }, 1000);
    });

    peer.on('error', err => {
        clearTimeout(openTimeout);
        dbg(`peer error: ${err.type} ‚Äî ${err.message}`, 'err');

        if (err.type === 'unavailable-id') { resetUI('Room ID taken. Try another.'); return; }

        if (err.type === 'peer-unavailable') {
            // Host not found ‚Äî retry a few times before giving up
            if (retryCount < MAX_RETRIES) {
                retryCount++;
                setStatus(`Host not found. Retry ${retryCount}/${MAX_RETRIES} in 2s...`);
                setTimeout(() => connectToHost(targetHostId || state.targetHostId), 2000);
            } else {
                resetUI('Host not found. Is the Room ID correct?');
            }
            return;
        }

        // For network/server errors, try next config
        tryNextServerConfig(myId, targetHostId, err.type);
    });

    peer.on('disconnected', () => {
        dbg('peer disconnected from server', 'err');
        if (peer && !peer.destroyed) peer.reconnect();
    });
}

function tryNextServerConfig(myId, targetHostId, reason) {
    if (peer) { try { peer.destroy(); } catch(e){} peer=null; }

    serverConfigIdx++;
    if (serverConfigIdx < PEER_SERVER_CONFIGS.length) {
        dbg(`Switching to config ${serverConfigIdx+1}`, 'info');
        setStatus(`${reason}. Trying backup server...`);
        setTimeout(() => initPeer(myId, targetHostId), 1500);
    } else {
        resetUI(`All servers failed. Check your internet or firewall.`);
    }
}

// ================================================================
//  HOST READY
// ================================================================
function onHostReady(id) {
    document.getElementById('host-settings-group').classList.remove('hidden');
    userList = [{id, username:state.username, avatar:state.avatar, color:state.color, isCoHost:true}];
    enterApp(id);
    updateUserListUI();
}

// ================================================================
//  CONNECT TO HOST (GUEST)
// ================================================================
function connectToHost(hostId) {
    if (!peer || !peer.open) { dbg('peer not open, waiting...', 'err'); return; }
    clearTimeout(connTimeout);
    setStatus(`Connecting to host "${hostId}"...`);
    dbg(`connect ‚Üí ${hostId}`, 'info');

    try {
        hostConn = peer.connect(hostId, {
            metadata: {username:state.username, avatar:state.avatar, color:state.color},
            reliable: true
        });
    } catch(e) {
        dbg(`peer.connect threw: ${e.message}`, 'err');
        resetUI('Failed to connect. ' + e.message);
        return;
    }

    connTimeout = setTimeout(() => {
        if (!hostConn || !hostConn.open) {
            dbg('hostConn open timeout', 'err');
            if (retryCount < MAX_RETRIES) {
                retryCount++;
                setStatus(`Timeout. Retry ${retryCount}/${MAX_RETRIES}...`);
                try { hostConn && hostConn.close(); } catch(e){}
                setTimeout(() => connectToHost(hostId), 1500);
            } else {
                resetUI('Timed out connecting to host. Is the host online?');
            }
        }
    }, 12000);

    hostConn.on('open', () => {
        clearTimeout(connTimeout);
        retryCount = 0;
        dbg('hostConn open ‚úì', 'ok');
        addSystemMsg('Joined Room!');
        setupConn(hostConn);
        enterApp(hostId);
        document.getElementById('my-peer-id').innerText = hostId;
    });

    hostConn.on('close', () => { toast('Host disconnected','error'); setTimeout(()=>location.reload(),2000); });
    hostConn.on('error', e => {
        clearTimeout(connTimeout);
        dbg(`hostConn error: ${e}`, 'err');
        if (retryCount < MAX_RETRIES) {
            retryCount++;
            setStatus(`Conn error. Retry ${retryCount}/${MAX_RETRIES}...`);
            setTimeout(() => connectToHost(hostId), 1500);
        } else {
            resetUI('Connection failed to host.');
        }
    });
}

// ================================================================
//  CONNECTION SETUP (shared host/guest)
// ================================================================
function setupConn(conn) {
    if (state.mode==='create' && conn.metadata) {
        const {username,avatar,color} = conn.metadata;
        userList.push({id:conn.peer,username,avatar,color,isCoHost:false});
        broadcastUserList();
        const msg=`${username} joined`;
        broadcast({type:'system',msg}); addSystemMsg(msg); playPing();
    }
    conn.on('data', d => handleData(d, conn));
    conn.on('close', () => {
        if (state.mode==='create') {
            connections = connections.filter(c=>c!==conn);
            const idx = userList.findIndex(u=>u.id===conn.peer);
            if (idx!==-1) {
                const u=userList.splice(idx,1)[0];
                broadcastUserList();
                const msg=`${u.username} left`;
                addSystemMsg(msg); broadcast({type:'system',msg});
            }
        }
    });
}

function enterApp(id) {
    document.getElementById('login-view').classList.add('hidden');
    document.getElementById('app-view').classList.remove('hidden');
    if (state.mode==='create') document.getElementById('my-peer-id').innerText = id;
    updateProfileUI();
    initYouTube();
}

function updateProfileUI() {
    const el = document.getElementById('user-avatar-display');
    el.innerText=state.avatar;
    el.className=`w-9 h-9 rounded-full ${state.color} flex items-center justify-center font-bold text-sm shadow-inner cursor-pointer`;
}

// ================================================================
//  USER LIST
// ================================================================
function broadcastUserList() { broadcast({type:'user-list',list:userList}); updateUserListUI(); }
function updateUserListUI() {
    const c = document.getElementById('user-list-container');
    document.getElementById('user-count').innerText = userList.length;
    c.innerHTML='';
    userList.forEach(u => {
        const isMe = u.id===(state.mode==='create'?state.id:peer?.id);
        const role = u.isCoHost?(u.id===state.id&&state.mode==='create'?'HOST':'CO-HOST'):'USER';
        const rc = u.isCoHost?'text-indigo-400':'text-slate-500';
        let ctrl = '';
        if (state.mode==='create'&&!isMe) ctrl=`<div class="flex gap-2 opacity-0 group-hover:opacity-100 transition"><button onclick="promoteUser('${u.id}')" class="text-indigo-400 hover:text-white"><i data-lucide="shield-plus" class="w-4 h-4"></i></button><button onclick="kickUser('${u.id}')" class="text-red-400 hover:text-white"><i data-lucide="user-x" class="w-4 h-4"></i></button></div>`;
        const d=document.createElement('div');
        d.className='flex items-center justify-between p-2 rounded-lg hover:bg-slate-800/50 group transition';
        d.innerHTML=`<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full ${u.color} flex items-center justify-center text-sm">${u.avatar}</div><div><p class="text-xs font-bold text-slate-200">${u.username}${isMe?' <span class="text-[9px] bg-slate-700 px-1 rounded text-slate-400">YOU</span>':''}</p><p class="text-[9px] ${rc}">${role}</p></div></div>${ctrl}`;
        c.appendChild(d);
    });
    lucide.createIcons();
}
function kickUser(id) { const c=connections.find(c=>c.peer===id); if(c){c.send({type:'error',msg:'Kicked.'});setTimeout(()=>c.close(),500);} }
function promoteUser(id) { const u=userList.find(u=>u.id===id); if(!u)return; u.isCoHost=!u.isCoHost; broadcastUserList(); const c=connections.find(c=>c.peer===id); if(c)c.send({type:'promote',val:u.isCoHost}); toast(`Updated ${u.username}`,'success'); }

// ================================================================
//  DATA HANDLING
// ================================================================
function handleData(data, senderConn) {
    if (data.type==='error') { alert(data.msg); location.reload(); return; }
    if (data.type==='chat') { addChat(data.user,data.msg,data.avatar,data.color); playPing(); if(state.mode==='create')broadcast(data,senderConn); if(document.getElementById('chat-sidebar').classList.contains('translate-x-full'))document.getElementById('chat-badge').classList.remove('hidden'); }
    else if (data.type==='system') { addSystemMsg(data.msg); if(state.mode==='create')broadcast(data,senderConn); }
    else if (data.type==='video-action') { if(state.mode==='create'&&state.hostOnly&&!data.isHost)return; applyVideoAction(data.action,data.val); if(state.mode==='create')broadcast(data,senderConn); }
    else if (data.type==='sync-full') { state.hostOnly=data.hostOnly; updateLockUI(data.isLocked); if(data.video?.type==='youtube'){document.getElementById('url-input').value=`https://youtu.be/${data.video.src}`;state.video=data.video;loadVideo(true);}else if(data.video?.type==='file')addSystemMsg('Host is watching a local file. Load the same file.'); if(data.video?.speed)changeSpeed(data.video.speed,true); }
    else if (data.type==='settings') { if(data.key==='hostOnly')state.hostOnly=data.val; if(data.key==='isLocked')updateLockUI(data.val); }
    else if (data.type==='user-list') { userList=data.list; updateUserListUI(); }
    else if (data.type==='promote') { state.isCoHost=data.val; toast(state.isCoHost?'You are now Co-Host':'Co-Host removed','info'); }
    else if (data.type==='update-profile') { if(state.mode==='create'){const u=userList.find(u=>u.id===senderConn.peer);if(u){u.username=data.username;u.avatar=data.avatar;u.color=data.color;broadcastUserList();}} }
}
function broadcast(data, exclude=null) { connections.forEach(c=>{ if(c!==exclude&&c.open)c.send(data); }); }

// ================================================================
//  VIDEO
// ================================================================
function initYouTube() { if(!window.YT){const t=document.createElement('script');t.src='https://www.youtube.com/iframe_api';document.body.appendChild(t);} }
function loadVideo(isRemote=false) {
    const url=document.getElementById('url-input').value;
    const ytId=extractYTId(url);
    if(!ytId)return;
    state.video.type='youtube'; state.video.src=ytId;
    activatePlayer('youtube');
    if(!state.ytPlayer){ state.ytPlayer=new YT.Player('youtube-player',{height:'100%',width:'100%',videoId:ytId,playerVars:{autoplay:1,controls:0,rel:0},events:{onStateChange:onYTState}}); }
    else { state.ytPlayer.loadVideoById(ytId); }
    if(!isRemote)sendVideoAction('change',{type:'youtube',src:ytId});
}
function handleFile(input) {
    const f=input.files[0]; if(!f)return;
    const url=URL.createObjectURL(f);
    if(state.ytPlayer?.stopVideo)state.ytPlayer.stopVideo();
    state.video.type='file'; activatePlayer('html5');
    const v=document.getElementById('html5-player');
    v.src=url; v.playbackRate=state.video.speed;
    v.onplay=()=>sendVideoAction('play',v.currentTime);
    v.onpause=()=>sendVideoAction('pause',v.currentTime);
    v.onseeked=()=>sendVideoAction('seek',v.currentTime);
    toast('File loaded','success');
    if(state.mode==='create')broadcast({type:'video-action',action:'change',val:{type:'file'}});
    input.value='';
}
function onYTState(e) { if(isSyncing)return; if(e.data==YT.PlayerState.PLAYING)sendVideoAction('play',state.ytPlayer.getCurrentTime()); if(e.data==YT.PlayerState.PAUSED)sendVideoAction('pause',state.ytPlayer.getCurrentTime()); }
function sendVideoAction(action,val) {
    if(isSyncing)return;
    if(state.mode!=='create'&&state.hostOnly&&!state.isCoHost){toast('Controls Locked','error');return;}
    const data={type:'video-action',action,val,isHost:state.mode==='create'||state.isCoHost};
    if(action==='play')state.video.state='playing'; if(action==='pause')state.video.state='paused';
    if(action==='seek')state.video.time=val; if(action==='speed')state.video.speed=val;
    if(state.mode==='create')broadcast(data); else if(hostConn?.open)hostConn.send(data);
}
function applyVideoAction(action,val) {
    isSyncing=true;
    const yt=state.ytPlayer, h5=document.getElementById('html5-player');
    if(action==='change'){ if(val.type==='youtube'){document.getElementById('url-input').value=`https://youtu.be/${val.src}`;loadVideo(true);}else addSystemMsg('Host switched to local file.'); }
    else if(action==='speed')changeSpeed(val,true);
    else if(state.video.type==='youtube'&&yt?.getPlayerState){ if(action==='play'){if(Math.abs(yt.getCurrentTime()-val)>1)yt.seekTo(val);yt.playVideo();}if(action==='pause'){yt.seekTo(val);yt.pauseVideo();}if(action==='seek')yt.seekTo(val); }
    else if(state.video.type==='file'){ if(action==='play'){if(Math.abs(h5.currentTime-val)>1)h5.currentTime=val;h5.play().catch(()=>{});}if(action==='pause'){h5.pause();h5.currentTime=val;}if(action==='seek')h5.currentTime=val; }
    setTimeout(()=>{isSyncing=false;},500);
}
function seekRelative(s) {
    if(state.mode!=='create'&&state.hostOnly&&!state.isCoHost){toast('Controls Locked','error');return;}
    let t=0;
    if(state.video.type==='youtube'&&state.ytPlayer)t=state.ytPlayer.getCurrentTime();
    else if(state.video.type==='file')t=document.getElementById('html5-player').currentTime;
    const n=Math.max(0,t+s);
    sendVideoAction('seek',n);
    if(state.video.type==='youtube')state.ytPlayer.seekTo(n);
    else if(state.video.type==='file')document.getElementById('html5-player').currentTime=n;
}
function activatePlayer(type) {
    document.getElementById('placeholder').classList.add('hidden');
    const h5=document.getElementById('html5-player'),yt=document.getElementById('youtube-player');
    if(type==='youtube'){h5.classList.add('hidden');h5.pause();yt.style.display='block';}
    else{yt.style.display='none';if(state.ytPlayer?.pauseVideo)state.ytPlayer.pauseVideo();h5.classList.remove('hidden');}
}
function extractYTId(url) { const m=url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/); return m&&m[2].length===11?m[2]:null; }
function changeSpeed(val,isRemote=false) { const s=parseFloat(val);state.video.speed=s;document.getElementById('speed-select').value=s;document.getElementById('html5-player').playbackRate=s;if(state.ytPlayer?.setPlaybackRate)state.ytPlayer.setPlaybackRate(s);if(!isRemote)sendVideoAction('speed',s); }
function handleSubtitle(input) { const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{let c=e.target.result;if(f.name.endsWith('.srt'))c='WEBVTT\n\n'+c.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g,'$1.$2');const b=new Blob([c],{type:'text/vtt'});document.getElementById('player-track').src=URL.createObjectURL(b);if(document.getElementById('html5-player').textTracks[0])document.getElementById('html5-player').textTracks[0].mode='showing';toast('Subtitles loaded','success');};r.readAsText(f); }

// ================================================================
//  CHAT & AI
// ================================================================
async function askAI(q) {
    const p=q||document.getElementById('chat-input').value.replace('@ai','').trim();
    if(!p)return; if(!apiKey)return toast('API Key required','error');
    sendChat(null,p); toast('Thinking...','info');
    try {
        const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:'Short fun response: '+p}]}]})});
        const d=await r.json(); const t=d.candidates?.[0]?.content?.parts?.[0]?.text||'Failed.';
        const msg={type:'chat',msg:t,user:'AI',avatar:'‚ú®',color:'bg-purple-600'};
        addChat('AI',t,'‚ú®','bg-purple-600'); playPing();
        if(state.mode==='create')broadcast(msg); else if(hostConn?.open)hostConn.send(msg);
    } catch(e){toast('AI Error','error');}
}
function sendChat(e,manual=null) {
    if(e)e.preventDefault();
    const inp=document.getElementById('chat-input');
    const msg=manual||inp.value.trim(); if(!msg)return;
    if(msg.startsWith('@ai')&&!manual){askAI(msg.replace('@ai','').trim());inp.value='';return;}
    const data={type:'chat',msg,user:state.username,avatar:state.avatar,color:state.color};
    addChat(state.username,msg,state.avatar,state.color,true); playPing();
    if(state.mode==='create')broadcast(data); else if(hostConn?.open)hostConn.send(data);
    if(inp)inp.value='';
}
function sendEmoji(e){sendChat(null,e);}
function addChat(user,msg,avatar,color,isMe=false) {
    const b=document.getElementById('chat-container'),d=document.createElement('div');
    d.className=`flex gap-3 ${isMe?'flex-row-reverse':''}`;
    d.innerHTML=`<div class="w-8 h-8 rounded-full ${color} flex items-center justify-center text-xs shrink-0 text-white">${avatar}</div><div class="${isMe?'bg-indigo-600 text-white':'bg-[#1f2937] text-slate-200'} p-3 rounded-2xl text-sm max-w-[85%]"><p class="text-[9px] opacity-70 mb-1 font-bold uppercase">${user}</p><p>${msg}</p></div>`;
    b.appendChild(d); b.scrollTop=b.scrollHeight;
}
function addSystemMsg(t) { const b=document.getElementById('chat-container'),d=document.createElement('div');d.className='text-center text-[10px] text-slate-500 my-3';d.innerText=t;b.appendChild(d);b.scrollTop=b.scrollHeight; }

// ================================================================
//  UTILS
// ================================================================
function toggleSettings(){const m=document.getElementById('settings-modal');if(m.open)m.close();else m.showModal();}
function toggleMobileChat(){const s=document.getElementById('chat-sidebar');if(s.classList.contains('translate-x-full')){s.classList.remove('translate-x-full');document.getElementById('chat-badge').classList.add('hidden');}else s.classList.add('translate-x-full');}
function toggleFullscreen(){const e=document.getElementById('video-box');if(!document.fullscreenElement)e.requestFullscreen().catch(()=>toast('FS Error','error'));else document.exitFullscreen();}
function switchTab(t){const cc=document.getElementById('view-chat'),cu=document.getElementById('view-users'),tc=document.getElementById('tab-chat'),tu=document.getElementById('tab-users');if(t==='chat'){cc.classList.remove('hidden');cu.classList.add('hidden');tc.className='w-1/2 py-3 text-xs font-bold text-indigo-400 border-b-2 border-indigo-500';tu.className='w-1/2 py-3 text-xs font-bold text-slate-500 flex items-center justify-center gap-1';}else{cc.classList.add('hidden');cu.classList.remove('hidden');tu.className='w-1/2 py-3 text-xs font-bold text-indigo-400 border-b-2 border-indigo-500';tc.className='w-1/2 py-3 text-xs font-bold text-slate-500';}}
function saveSettings(){const n=document.getElementById('modal-username').value;apiKey=document.getElementById('ai-api-key').value;if(n)state.username=n;localStorage.setItem('nw_profile',JSON.stringify({name:state.username,avatar:state.avatar,color:state.color,apiKey}));if(state.mode==='create'){const me=userList.find(u=>u.id===state.id);if(me){me.username=n;me.avatar=state.avatar;me.color=state.color;}broadcastUserList();updateProfileUI();}else if(hostConn?.open){hostConn.send({type:'update-profile',username:state.username,avatar:state.avatar,color:state.color});updateProfileUI();}toggleSettings();toast('Saved','success');}
function toggleHostOnly(){if(state.mode!=='create')return;state.hostOnly=!state.hostOnly;const b=document.getElementById('btn-host-only'),k=b.firstElementChild;if(state.hostOnly){b.classList.add('bg-indigo-600');b.classList.remove('bg-slate-700');k.classList.add('translate-x-5');}else{b.classList.remove('bg-indigo-600');b.classList.add('bg-slate-700');k.classList.remove('translate-x-5');}broadcast({type:'settings',key:'hostOnly',val:state.hostOnly});}
function toggleRoomLock(){if(state.mode!=='create')return;state.isLocked=!state.isLocked;updateLockUI(state.isLocked);const b=document.getElementById('btn-lock-room'),k=b.firstElementChild;if(state.isLocked){b.classList.add('bg-indigo-600');b.classList.remove('bg-slate-700');k.classList.add('translate-x-5');}else{b.classList.remove('bg-indigo-600');b.classList.add('bg-slate-700');k.classList.remove('translate-x-5');}broadcast({type:'settings',key:'isLocked',val:state.isLocked});}
function updateLockUI(l){document.getElementById('room-locked-indicator').classList.toggle('hidden',!l);}
function copyId(){const id=document.getElementById('my-peer-id').innerText;if(id==='...')return;navigator.clipboard.writeText(id).then(()=>toast('Copied!','success'));}
function toast(msg,type='info'){const c=document.getElementById('toast-container'),d=document.createElement('div');let cl='bg-[#151923] border-slate-700';if(type==='success')cl='bg-emerald-900/80 border-emerald-500/50';if(type==='error')cl='bg-red-900/80 border-red-500/50';d.className=`${cl} text-white border px-4 py-3 rounded-xl text-xs font-bold shadow-2xl backdrop-blur-md flex items-center gap-3 toast-enter`;d.innerHTML=type==='success'?`<i data-lucide="check-circle" class="w-4 h-4 text-emerald-400"></i> ${msg}`:type==='error'?`<i data-lucide="alert-circle" class="w-4 h-4 text-red-400"></i> ${msg}`:msg;c.appendChild(d);lucide.createIcons();setTimeout(()=>d.remove(),3500);}
</script>
</body>
</html>
