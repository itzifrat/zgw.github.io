<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZG WatchTogether | P2P Ultimate</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PeerJS (Networking) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root { --bg-dark: #0f172a; --primary: #3b82f6; }
        body { background-color: var(--bg-dark); color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* Video Container - Responsive Aspect Ratio */
        .video-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .video-container { 
            position: relative; 
            width: 100%; 
            max-width: 100%;
            max-height: 100%;
            aspect-ratio: 16/9;
            background: black; 
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); 
            transition: box-shadow 0.3s; 
        }
        .video-container:hover { box-shadow: 0 25px 50px -12px rgba(0,0,0,0.7); }
        .video-container iframe, .video-container video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; outline: none; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px) translateX(-50%); } to { opacity: 1; transform: translateY(0) translateX(-50%); } }
        
        .avatar-option { transition: all 0.2s; cursor: pointer; opacity: 0.7; transform: scale(0.95); }
        .avatar-option:hover { opacity: 1; transform: scale(1.05); }
        .avatar-option.selected { opacity: 1; transform: scale(1.15); border-color: var(--primary); box-shadow: 0 0 15px rgba(59, 130, 246, 0.6); }
        
        .tab-btn { @apply flex-1 py-2 text-sm font-medium border-b-2 transition-colors duration-200; }
        .tab-btn.active { @apply border-blue-500 text-blue-400; }
        .tab-btn.inactive { @apply border-transparent text-slate-500 hover:text-slate-300; }

        /* Custom Range & Scroll */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        /* Mobile Sidebar Transition */
        .mobile-sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .mobile-sidebar.closed {
            transform: translateX(100%);
        }
    </style>
</head>
<body class="h-screen w-screen relative flex flex-col">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-16 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none w-max max-w-[90%]"></div>

    <!-- Settings Modal -->
    <dialog id="settings-modal" class="bg-transparent p-0 backdrop:bg-black/60 backdrop:backdrop-blur-sm w-full max-w-md m-auto">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl p-6 text-white mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5 text-blue-400"></i> Settings</h2>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Profile</label>
                    <div class="flex gap-3">
                        <div id="modal-avatar" class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xl"></div>
                        <input type="text" id="modal-username" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 text-sm focus:border-blue-500 outline-none">
                    </div>
                </div>
                
                <div id="host-settings-group" class="hidden">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Moderation (Host)</label>
                    <div class="flex items-center justify-between bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                        <span class="text-sm">Host-Only Controls</span>
                        <button id="btn-host-only" onclick="toggleHostOnly()" class="w-10 h-5 rounded-full bg-slate-700 relative transition-colors">
                            <div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform"></div>
                        </button>
                    </div>
                    <p class="text-[10px] text-slate-500 mt-1">If enabled, guests cannot play/pause or seek.</p>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">AI Integration</label>
                    <input type="password" id="ai-api-key" placeholder="Paste Gemini API Key here" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:border-purple-500 outline-none">
                    <p class="text-[10px] text-slate-500 mt-1">Required to use @ai in chat.</p>
                </div>

                <button onclick="saveSettings()" class="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded-lg font-bold text-sm">Save Changes</button>
            </div>
        </div>
    </dialog>

    <!-- Login View -->
    <div id="login-view" class="absolute inset-0 z-50 flex items-center justify-center bg-slate-900 bg-[url('https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80&w=2525&auto=format&fit=crop')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div>
        <div class="relative bg-slate-800/90 border border-slate-700 p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-6">
                <div class="bg-gradient-to-tr from-blue-600 to-purple-600 w-16 h-16 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg"><i data-lucide="monitor-play" class="text-white w-8 h-8"></i></div>
                <h1 class="text-2xl font-bold text-white">ZG WatchTogether</h1>
                <p class="text-slate-400 text-sm">P2P ‚Ä¢ Private ‚Ä¢ Sync</p>
            </div>

            <!-- Avatar Selector -->
            <div class="flex justify-center gap-4 mb-6">
                <div class="avatar-option w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-lg border-2 border-transparent" onclick="selectAvatar('üëæ', 'bg-blue-600')">üëæ</div>
                <div class="avatar-option w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center text-lg border-2 border-transparent" onclick="selectAvatar('üê±', 'bg-purple-600')">üê±</div>
                <div class="avatar-option w-10 h-10 rounded-full bg-emerald-600 flex items-center justify-center text-lg border-2 border-transparent" onclick="selectAvatar('ü§ñ', 'bg-emerald-600')">ü§ñ</div>
                <div class="avatar-option w-10 h-10 rounded-full bg-orange-600 flex items-center justify-center text-lg border-2 border-transparent" onclick="selectAvatar('ü¶ä', 'bg-orange-600')">ü¶ä</div>
            </div>

            <div class="space-y-4">
                <input type="text" id="username-input" placeholder="Display Name" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition">
                
                <div class="flex border-b border-slate-700">
                    <button onclick="switchMode('create')" id="btn-mode-create" class="tab-btn active">Create Room</button>
                    <button onclick="switchMode('join')" id="btn-mode-join" class="tab-btn inactive">Join Room</button>
                </div>

                <div id="join-input-group" class="hidden">
                    <input type="text" id="room-id-input" placeholder="Enter Room ID" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>

                <button onclick="handleStart()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-95" id="action-btn">Create Room</button>
                <p id="status-msg" class="text-center text-xs text-slate-400 h-4"></p>
            </div>
        </div>
    </div>

    <!-- App View -->
    <div id="app-view" class="flex flex-col h-full hidden">
        <header class="h-16 border-b border-slate-700 flex items-center justify-between px-4 md:px-6 bg-slate-900 z-20 shrink-0">
            <div class="flex items-center gap-3">
                <i data-lucide="monitor-play" class="text-blue-500 w-6 h-6"></i>
                <div class="hidden md:block">
                    <h1 class="font-bold text-white">ZG WatchTogether</h1>
                    <p class="text-[10px] text-slate-400 cursor-pointer hover:text-blue-400 transition" onclick="copyId()">
                        Room ID: <span id="my-peer-id" class="font-mono">...</span> <i data-lucide="copy" class="inline w-3 h-3 ml-1"></i>
                    </p>
                </div>
            </div>
            
            <div class="flex items-center gap-3 md:gap-4">
                <button onclick="toggleMobileChat()" class="md:hidden text-slate-400 hover:text-white p-2 relative">
                    <i data-lucide="message-square" class="w-5 h-5"></i>
                    <span id="chat-badge" class="absolute top-1 right-1 w-2 h-2 bg-blue-500 rounded-full hidden"></span>
                </button>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-white transition"><i data-lucide="settings" class="w-5 h-5"></i></button>
                <div class="h-6 w-px bg-slate-700"></div>
                <div id="peer-status" class="px-3 py-1 rounded-full bg-slate-800 text-xs font-medium text-slate-400 border border-slate-700 flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-slate-500"></div> <span class="hidden sm:inline">Offline</span>
                </div>
                <div id="user-avatar-display" class="w-9 h-9 rounded-full bg-slate-700 flex items-center justify-center font-bold text-lg shadow-inner cursor-pointer" onclick="toggleSettings()">?</div>
            </div>
        </header>

        <main class="flex-1 flex overflow-hidden relative">
            <!-- Left: Video & Controls -->
            <div class="flex-1 flex flex-col bg-black relative w-full h-full">
                <!-- Floating Source Input -->
                <div class="absolute top-0 left-0 w-full p-2 md:p-4 z-20 opacity-0 hover:opacity-100 transition duration-300 bg-gradient-to-b from-black/90 to-transparent flex justify-center">
                    <div class="flex flex-wrap justify-center gap-2 bg-slate-900/90 backdrop-blur p-2 rounded-xl border border-slate-700 w-full max-w-2xl shadow-2xl">
                        <div class="flex items-center flex-1 min-w-[200px] gap-2">
                            <i data-lucide="link" class="w-4 h-4 text-slate-500 ml-2 hidden sm:block"></i>
                            <input type="text" id="url-input" placeholder="YouTube / MP4 URL" class="bg-transparent border-none text-xs w-full text-white focus:ring-0 outline-none">
                            <button onclick="loadVideo()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded-lg text-xs font-bold text-white transition">Play</button>
                        </div>
                        <div class="w-px h-6 bg-slate-700 hidden sm:block"></div>
                        <button onclick="document.getElementById('file-input').click()" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg text-xs text-white border border-slate-700 transition">
                            <i data-lucide="file-video" class="w-3 h-3 text-emerald-500"></i> <span class="hidden sm:inline">File</span>
                        </button>
                        <input type="file" id="file-input" class="hidden" accept="video/*" onchange="handleFile(this)">
                    </div>
                </div>

                <!-- Video Stage -->
                <div class="flex-1 overflow-hidden bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 to-black p-2 md:p-4 flex flex-col justify-center">
                    <div class="video-wrapper">
                        <div class="video-container ring-1 ring-white/10">
                            <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 text-slate-500 z-10">
                                <i data-lucide="film" class="w-12 h-12 md:w-16 md:h-16 mb-4 opacity-50"></i>
                                <h3 class="text-lg md:text-xl font-bold text-white text-center">Ready?</h3>
                                <p class="text-xs md:text-sm text-center px-4">Paste a link or load a file to start.</p>
                            </div>
                            <video id="html5-player" class="hidden" controls playsinline crossorigin="anonymous">
                                <track id="player-track" kind="subtitles" srclang="en" label="English" default>
                            </video>
                            <div id="youtube-player" class="hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Controls Bar -->
                <div class="w-full bg-slate-900 border-t border-slate-800 px-2 md:px-4 py-2 flex items-center justify-between shrink-0 z-20 text-xs text-slate-300">
                    <div class="flex items-center gap-2 md:gap-4 overflow-x-auto">
                        <div class="flex items-center gap-2 shrink-0">
                            <span class="font-bold uppercase text-[10px] text-slate-500">Speed</span>
                            <select id="speed-select" onchange="changeSpeed(this.value)" class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5 focus:border-blue-500 outline-none">
                                <option value="0.5">0.5x</option>
                                <option value="1" selected>1.0x</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                                <option value="2">2.0x</option>
                            </select>
                        </div>
                        <button onclick="document.getElementById('sub-input').click()" class="flex items-center gap-1 hover:text-white transition shrink-0">
                            <i data-lucide="captions" class="w-3.5 h-3.5"></i> <span class="hidden sm:inline">Subtitles</span>
                        </button>
                        <input type="file" id="sub-input" accept=".vtt,.srt" class="hidden" onchange="handleSubtitle(this)">
                    </div>
                    <div class="flex items-center gap-2 shrink-0">
                        <span id="sync-dot" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span id="sync-text" class="hidden sm:inline">Synced</span>
                    </div>
                </div>
                
                <!-- Webcam Strip -->
                <div class="h-24 md:h-28 bg-slate-950 border-t border-slate-800 flex items-center px-4 gap-3 overflow-x-auto shrink-0">
                    <div class="relative w-32 md:w-36 h-16 md:h-20 bg-black rounded-lg border border-slate-700 shrink-0 overflow-hidden group">
                        <video id="my-webcam" autoplay muted playsinline class="w-full h-full object-cover transform scale-x-[-1]"></video>
                        <div class="absolute bottom-1 left-1 bg-black/60 px-1.5 rounded text-[9px] text-white font-bold backdrop-blur">YOU</div>
                        <div class="absolute inset-0 flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 bg-black/40 transition">
                            <button onclick="toggleCam()" class="p-1.5 bg-slate-700 rounded-full hover:bg-slate-600 text-white"><i data-lucide="video" class="w-3.5 h-3.5"></i></button>
                            <button onclick="toggleMic()" class="p-1.5 bg-slate-700 rounded-full hover:bg-slate-600 text-white"><i data-lucide="mic" class="w-3.5 h-3.5"></i></button>
                        </div>
                    </div>
                    <!-- Remote streams container -->
                    <div id="remote-streams" class="flex gap-3"></div>
                </div>
            </div>

            <!-- Right: Chat & Sidebar (Responsive) -->
            <div id="chat-sidebar" class="mobile-sidebar absolute inset-y-0 right-0 w-80 bg-slate-900 border-l border-slate-800 flex flex-col z-30 md:static transform translate-x-full md:translate-x-0 closed">
                <!-- Mobile Close Button -->
                <button onclick="toggleMobileChat()" class="md:hidden absolute top-2 right-2 p-2 text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                
                <div class="flex border-b border-slate-800 mt-8 md:mt-0">
                    <button class="flex-1 py-3 text-xs font-bold uppercase tracking-wide text-blue-400 border-b-2 border-blue-500 bg-slate-800/50">Chat</button>
                    <button class="flex-1 py-3 text-xs font-bold uppercase tracking-wide text-slate-500">Files</button>
                </div>
                
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <div class="text-center text-[10px] text-slate-500 my-2">Room Created</div>
                </div>

                <!-- AI Chips -->
                <div id="ai-chips" class="px-3 pb-2 flex gap-2 overflow-x-auto hidden">
                    <button onclick="askAI('Suggest a movie')" class="whitespace-nowrap bg-purple-900/30 border border-purple-500/30 text-purple-300 text-[10px] px-2 py-1 rounded-full hover:bg-purple-900/50 transition">‚ú® Movie Idea</button>
                    <button onclick="askAI('Fun fact about this')" class="whitespace-nowrap bg-purple-900/30 border border-purple-500/30 text-purple-300 text-[10px] px-2 py-1 rounded-full hover:bg-purple-900/50 transition">‚ú® Fun Fact</button>
                </div>

                <form onsubmit="sendChat(event)" class="p-3 bg-slate-800/50 border-t border-slate-700 relative">
                    <input id="chat-input" type="text" placeholder="Type or @ai for bot..." class="w-full bg-slate-950 border border-slate-700 rounded-lg py-2.5 pl-3 pr-9 text-xs text-white focus:border-blue-500 outline-none transition shadow-inner">
                    <button type="submit" class="absolute right-4 top-4 text-slate-400 hover:text-blue-500"><i data-lucide="send-horizontal" class="w-4 h-4"></i></button>
                </form>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const generateId = () => Math.random().toString(36).substring(2, 8);
        let peer;
        let connections = []; // For Host
        let hostConn = null;  // For Guest
        let isSyncing = false; // Lock to prevent loop
        let localStream = null;
        let apiKey = ""; // AI Key

        const state = {
            mode: 'create', // create | join
            id: null,
            username: 'Guest',
            avatar: 'üëæ',
            color: 'bg-blue-600',
            hostOnly: false,
            video: { type: null, src: null, time: 0, state: 'paused', speed: 1.0 },
            ytPlayer: null
        };

        // --- INIT ---
        window.onload = () => {
            lucide.createIcons();
            loadProfile();
            
            // Check URL
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('join')) {
                switchMode('join');
                document.getElementById('room-id-input').value = urlParams.get('join');
            }
            
            initWebcam();
        };

        function loadProfile() {
            const saved = localStorage.getItem('zg_p2p_profile');
            if(saved) {
                const p = JSON.parse(saved);
                document.getElementById('username-input').value = p.name;
                document.getElementById('modal-username').value = p.name;
                selectAvatar(p.avatar, p.color);
                apiKey = p.apiKey || "";
                document.getElementById('ai-api-key').value = apiKey;
                if(apiKey) document.getElementById('ai-chips').classList.remove('hidden');
            }
        }

        // --- LOGIN LOGIC ---
        function switchMode(mode) {
            state.mode = mode;
            const btnCreate = document.getElementById('btn-mode-create');
            const btnJoin = document.getElementById('btn-mode-join');
            const joinInput = document.getElementById('join-input-group');
            const actionBtn = document.getElementById('action-btn');

            if(mode === 'create') {
                btnCreate.classList.replace('inactive', 'active');
                btnJoin.classList.replace('active', 'inactive');
                joinInput.classList.add('hidden');
                actionBtn.innerText = "Start Hosting";
                actionBtn.classList.replace('bg-emerald-600', 'bg-blue-600');
            } else {
                btnJoin.classList.replace('inactive', 'active');
                btnCreate.classList.replace('active', 'inactive');
                joinInput.classList.remove('hidden');
                actionBtn.innerText = "Join Room";
                actionBtn.classList.replace('bg-blue-600', 'bg-emerald-600');
            }
        }

        function selectAvatar(av, col) {
            state.avatar = av; state.color = col;
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            // Update UI in both login and modal
            document.getElementById('modal-avatar').innerText = av;
            document.getElementById('modal-avatar').className = `w-10 h-10 rounded-full ${col} flex items-center justify-center text-xl`;
        }

        async function handleStart() {
            const name = document.getElementById('username-input').value.trim();
            if(!name) return toast("Please enter a name", "error");
            state.username = name;
            
            // Save profile
            localStorage.setItem('zg_p2p_profile', JSON.stringify({
                name, avatar: state.avatar, color: state.color, apiKey
            }));

            document.getElementById('action-btn').disabled = true;
            document.getElementById('status-msg').innerText = "Connecting to P2P Cloud...";

            if(state.mode === 'create') {
                state.id = generateId();
                state.hostOnly = false; // Default
                initPeer(state.id);
            } else {
                const hostId = document.getElementById('room-id-input').value.trim();
                if(!hostId) return toast("Enter Host ID", "error");
                state.id = generateId(); // Guest needs random ID
                initPeer(state.id, hostId);
            }
        }

        // --- PEERJS LOGIC ---
        function initPeer(myId, targetHostId = null) {
            peer = new Peer(myId, { debug: 1 });

            peer.on('open', (id) => {
                enterApp(id);
                if(targetHostId) connectToHost(targetHostId);
                else {
                    setStatus("Hosting", "bg-blue-500");
                    addSystemMsg(`Room Created. Share ID: ${id}`);
                    document.getElementById('host-settings-group').classList.remove('hidden'); // Show host controls
                }
            });

            peer.on('connection', (conn) => {
                connections.push(conn);
                setupConnection(conn);
                if(state.mode === 'create') {
                    addSystemMsg("New user connected. Syncing...");
                    setTimeout(() => {
                        if(conn.open) conn.send({ 
                            type: 'sync-full', 
                            video: state.video,
                            hostOnly: state.hostOnly
                        });
                    }, 1000);
                }
            });

            peer.on('error', (err) => {
                console.error(err);
                toast("Connection Error: " + err.type, "error");
            });
        }

        function connectToHost(hostId) {
            hostConn = peer.connect(hostId);
            setStatus("Connecting...", "bg-yellow-500");
            
            hostConn.on('open', () => {
                setStatus("Connected", "bg-emerald-500");
                addSystemMsg("Joined Room!");
                setupConnection(hostConn);
            });
            
            hostConn.on('close', () => {
                toast("Host Disconnected", "error");
                setTimeout(() => location.reload(), 2000);
            });
        }

        function setupConnection(conn) {
            conn.on('data', (data) => handleData(data, conn));
        }

        function enterApp(id) {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('my-peer-id').innerText = id;
            updateProfileUI();
            initYouTube();
        }

        function updateProfileUI() {
            const el = document.getElementById('user-avatar-display');
            el.innerText = state.avatar;
            el.className = `w-9 h-9 rounded-full ${state.color} flex items-center justify-center font-bold text-lg shadow-inner cursor-pointer`;
        }

        // --- CORE DATA HANDLING ---
        function handleData(data, senderConn) {
            if(data.type === 'chat') {
                addChat(data.user, data.msg, data.avatar, data.color);
                
                // Show badge if chat closed
                if(document.getElementById('chat-sidebar').classList.contains('closed')) {
                    document.getElementById('chat-badge').classList.remove('hidden');
                }

                if(state.mode === 'create') broadcast(data, senderConn);
            }
            else if (data.type === 'video-action') {
                // Host-Only Check
                if(state.mode === 'create' && state.hostOnly && !data.isHost) {
                    // Ignore non-host actions if restricted
                    return;
                }
                
                applyVideoAction(data.action, data.val);
                if(state.mode === 'create') broadcast(data, senderConn);
            }
            else if (data.type === 'sync-full') {
                // Initial load
                state.hostOnly = data.hostOnly;
                if(data.video.type === 'youtube') {
                    document.getElementById('url-input').value = `https://youtu.be/${data.video.src}`;
                    state.video = data.video;
                    loadVideo(true);
                } else if(data.video.type === 'file') {
                    addSystemMsg("Host is watching a local file. Please load the same file.");
                }
                // Apply Speed
                if(data.video.speed) changeSpeed(data.video.speed, true);
            }
            else if (data.type === 'settings') {
                if(data.key === 'hostOnly') state.hostOnly = data.val;
            }
        }

        function broadcast(data, excludeConn = null) {
            connections.forEach(c => {
                if(c !== excludeConn && c.open) c.send(data);
            });
        }

        // --- VIDEO LOGIC ---
        function initYouTube() {
            if(!window.YT) {
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                document.body.appendChild(tag);
            }
        }

        function loadVideo(isRemote = false) {
            const url = document.getElementById('url-input').value;
            const ytId = extractYouTubeId(url);
            
            if(ytId) {
                state.video.type = 'youtube';
                state.video.src = ytId;
                activatePlayer('youtube');
                
                if(!state.ytPlayer) {
                    state.ytPlayer = new YT.Player('youtube-player', {
                        height: '100%', width: '100%', videoId: ytId,
                        playerVars: { autoplay: 1, controls: 0, rel: 0 },
                        events: { onStateChange: onPlayerStateChange }
                    });
                } else {
                    state.ytPlayer.loadVideoById(ytId);
                }
                
                if(!isRemote) sendVideoAction('change', { type: 'youtube', src: ytId });
            }
        }

        function handleFile(input) {
            const file = input.files[0];
            if(!file) return;
            const url = URL.createObjectURL(file);
            
            state.video.type = 'file';
            activatePlayer('html5');
            const v = document.getElementById('html5-player');
            v.src = url;
            v.playbackRate = state.video.speed; // Apply current speed
            
            // Listeners
            v.onplay = () => sendVideoAction('play', v.currentTime);
            v.onpause = () => sendVideoAction('pause', v.currentTime);
            v.onseeked = () => sendVideoAction('seek', v.currentTime);
            
            toast("Local file loaded", "success");
            // Notify others to expect file mode
            if(state.mode === 'create') broadcast({ type: 'video-action', action: 'change', val: { type: 'file' }});
        }

        // The Fix for Feedback Loops
        function onPlayerStateChange(e) {
            if(isSyncing) return; // Ignore events triggered by code
            if(e.data == YT.PlayerState.PLAYING) sendVideoAction('play', state.ytPlayer.getCurrentTime());
            if(e.data == YT.PlayerState.PAUSED) sendVideoAction('pause', state.ytPlayer.getCurrentTime());
        }

        function sendVideoAction(action, val) {
            if(isSyncing) return;
            // Permission check for Guest
            if(state.mode !== 'create' && state.hostOnly) {
                toast("Host has locked controls", "error");
                return;
            }

            const data = { type: 'video-action', action, val, isHost: state.mode === 'create' };
            
            // Update local state record
            if(action === 'play') state.video.state = 'playing';
            if(action === 'pause') state.video.state = 'paused';
            if(action === 'seek') state.video.time = val;
            if(action === 'speed') state.video.speed = val;

            if(state.mode === 'create') broadcast(data);
            else if(hostConn && hostConn.open) hostConn.send(data);
        }

        function applyVideoAction(action, val) {
            isSyncing = true; // LOCK

            const yt = state.ytPlayer;
            const h5 = document.getElementById('html5-player');
            
            if(action === 'change') {
                if(val.type === 'youtube') {
                    document.getElementById('url-input').value = `https://youtu.be/${val.src}`;
                    loadVideo(true);
                } else if(val.type === 'file') {
                    addSystemMsg("Mode changed to File. Load your local file.");
                }
            }
            else if(action === 'speed') {
                changeSpeed(val, true);
            }
            else if(state.video.type === 'youtube' && yt && yt.getPlayerState) {
                if(action === 'play') {
                    if(Math.abs(yt.getCurrentTime() - val) > 1) yt.seekTo(val);
                    yt.playVideo();
                }
                if(action === 'pause') { yt.seekTo(val); yt.pauseVideo(); }
                if(action === 'seek') yt.seekTo(val);
            }
            else if(state.video.type === 'file') {
                if(action === 'play') { 
                    if(Math.abs(h5.currentTime - val) > 1) h5.currentTime = val;
                    h5.play().catch(e=>{}); 
                }
                if(action === 'pause') { h5.pause(); h5.currentTime = val; }
                if(action === 'seek') h5.currentTime = val;
            }

            setTimeout(() => { isSyncing = false; }, 500); // UNLOCK
        }

        function activatePlayer(type) {
            document.getElementById('placeholder').classList.add('hidden');
            const h5 = document.getElementById('html5-player');
            const yt = document.getElementById('youtube-player');
            if(type === 'youtube') { h5.classList.add('hidden'); yt.style.display = 'block'; }
            else { yt.style.display = 'none'; h5.classList.remove('hidden'); }
        }

        function extractYouTubeId(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // --- SUBTITLES & SPEED ---
        function changeSpeed(val, isRemote = false) {
            const speed = parseFloat(val);
            state.video.speed = speed;
            document.getElementById('speed-select').value = speed;
            
            const h5 = document.getElementById('html5-player');
            h5.playbackRate = speed;
            if(state.ytPlayer && state.ytPlayer.setPlaybackRate) state.ytPlayer.setPlaybackRate(speed);
            
            if(!isRemote) sendVideoAction('speed', speed);
        }

        function handleSubtitle(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                let content = e.target.result;
                // SRT to VTT basic conversion
                if(file.name.endsWith('.srt')) {
                    content = "WEBVTT\n\n" + content.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g, '$1.$2');
                }
                const blob = new Blob([content], {type: 'text/vtt'});
                const url = URL.createObjectURL(blob);
                const track = document.getElementById('player-track');
                track.src = url;
                
                // Force Update
                const vid = document.getElementById('html5-player');
                if(vid.textTracks[0]) vid.textTracks[0].mode = 'showing';
                
                toast("Subtitles Loaded", "success");
            };
            reader.readAsText(file);
        }

        // --- AI & CHAT ---
        async function askAI(query) {
            const prompt = query || document.getElementById('chat-input').value.replace('@ai', '').trim();
            if(!prompt) return;
            if(!apiKey) return toast("API Key required (Settings)", "error");

            sendChat(null, prompt); // Show user query
            toast("AI Thinking...", "info");

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: "Short movie fun response: " + prompt }] }] })
                });
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Thinking failed.";
                
                // Broadcast AI Response as a special chat message
                const msgData = { type: 'chat', msg: text, user: 'AI', avatar: '‚ú®', color: 'bg-purple-600' };
                addChat('AI', text, '‚ú®', 'bg-purple-600');
                if(state.mode === 'create') broadcast(msgData);
                else if(hostConn) hostConn.send(msgData);

            } catch(e) { toast("AI Error", "error"); }
        }

        function sendChat(e, manualMsg = null) {
            if(e) e.preventDefault();
            const inp = document.getElementById('chat-input');
            const msg = manualMsg || inp.value.trim();
            if(!msg) return;
            
            if(msg.startsWith('@ai') && !manualMsg) {
                askAI(msg.replace('@ai', '').trim());
                inp.value = '';
                return;
            }

            const data = { type: 'chat', msg, user: state.username, avatar: state.avatar, color: state.color };
            addChat(state.username, msg, state.avatar, state.color, true);
            
            if(state.mode === 'create') broadcast(data);
            else if(hostConn) hostConn.send(data);
            
            if(inp) inp.value = '';
        }

        function addChat(user, msg, avatar, color, isMe=false) {
            const box = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `flex gap-2 ${isMe ? 'flex-row-reverse' : ''} animate-fade`;
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full ${color} flex items-center justify-center text-xs shrink-0 text-white shadow-sm">${avatar}</div>
                <div class="${isMe ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-200'} p-2 rounded-lg text-sm max-w-[80%] shadow-md">
                    <p class="text-[10px] opacity-70 mb-0.5 font-bold uppercase">${user}</p>
                    <p>${msg}</p>
                </div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- UTILS & SETTINGS ---
        function toggleSettings() {
            const m = document.getElementById('settings-modal');
            if(m.open) m.close(); else m.showModal();
        }

        function toggleMobileChat() {
            const sb = document.getElementById('chat-sidebar');
            sb.classList.toggle('closed');
            // Hide badge when opening
            if(!sb.classList.contains('closed')) document.getElementById('chat-badge').classList.add('hidden');
        }

        function saveSettings() {
            const name = document.getElementById('modal-username').value;
            apiKey = document.getElementById('ai-api-key').value;
            if(name) state.username = name;
            
            // Persist
            localStorage.setItem('zg_p2p_profile', JSON.stringify({ name: state.username, avatar: state.avatar, color: state.color, apiKey }));
            
            if(apiKey) document.getElementById('ai-chips').classList.remove('hidden');
            toggleSettings();
            toast("Settings Saved", "success");
        }

        function toggleHostOnly() {
            if(state.mode !== 'create') return toast("Only Host can change this", "error");
            state.hostOnly = !state.hostOnly;
            
            const btn = document.getElementById('btn-host-only');
            const knob = btn.firstElementChild;
            if(state.hostOnly) {
                btn.classList.add('bg-blue-600'); btn.classList.remove('bg-slate-700'); knob.classList.add('translate-x-5');
            } else {
                btn.classList.remove('bg-blue-600'); btn.classList.add('bg-slate-700'); knob.classList.remove('translate-x-5');
            }
            
            // Broadcast setting change
            broadcast({ type: 'settings', key: 'hostOnly', val: state.hostOnly });
        }

        function setStatus(text, colorClass) {
            const el = document.getElementById('peer-status');
            el.innerHTML = `<div class="w-2 h-2 rounded-full ${colorClass} animate-pulse"></div> <span class="hidden sm:inline">${text}</span>`;
        }

        function copyId() {
            const id = document.getElementById('my-peer-id').innerText;
            if(id === '...') return;
            navigator.clipboard.writeText(id).then(() => toast("Room ID Copied!", "success"));
            // For convenience, update URL
            const url = window.location.origin + window.location.pathname + '?join=' + id;
            console.log("Share:", url);
        }

        function toast(msg, type='info') {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            let cl = 'bg-slate-800 border-slate-600';
            if(type=='success') cl='bg-emerald-600/90 border-emerald-500';
            if(type=='error') cl='bg-red-500/90 border-red-500';
            d.className = `${cl} text-white border px-4 py-2 rounded-lg text-xs font-bold shadow-xl backdrop-blur-md flex items-center gap-2 toast-enter`;
            d.innerText = msg;
            c.appendChild(d);
            setTimeout(()=>d.remove(), 3000);
        }

        function addSystemMsg(text) {
            const box = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = "text-center text-[10px] text-slate-500 my-2 bg-slate-800/50 py-1 rounded mx-auto px-2 inline-block";
            div.innerText = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- WEBCAM ---
        async function initWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                document.getElementById('my-webcam').srcObject = stream;
                state.stream = stream;
            } catch(e) { console.log("Cam error", e); }
        }
        function toggleCam() {
            if(state.stream) state.stream.getVideoTracks()[0].enabled = !state.stream.getVideoTracks()[0].enabled;
        }
        function toggleMic() {
            if(state.stream) state.stream.getAudioTracks()[0].enabled = !state.stream.getAudioTracks()[0].enabled;
        }

    </script>
</body>
</html>
