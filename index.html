<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NearWatch | P2P Encrypted</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PeerJS (Networking) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root { --bg-dark: #0b0e14; --primary: #6366f1; --surface: #151923; }
        body { background-color: var(--bg-dark); color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* Video Container Responsive Logic */
        .video-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        .video-container { 
            position: relative; 
            width: 100%;
            max-width: 100%;
            aspect-ratio: 16/9;
            max-height: 80vh; /* Prevent cut-off on laptops */
            background: black; 
            overflow: hidden; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); 
        }
        .video-container iframe, .video-container video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; outline: none; }

        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px) translateX(-50%); } to { opacity: 1; transform: translateY(0) translateX(-50%); } }
        
        .avatar-option { transition: all 0.2s; cursor: pointer; opacity: 0.7; transform: scale(0.95); }
        .avatar-option:hover { opacity: 1; transform: scale(1.05); }
        .avatar-option.selected { opacity: 1; transform: scale(1.15); border-color: var(--primary); box-shadow: 0 0 15px rgba(99, 102, 241, 0.6); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }

        /* Mobile Sidebar */
        .mobile-sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .mobile-sidebar.closed { transform: translateX(100%); }
        
        /* Quote Ticker */
        .quote-fade { animation: fadeInOut 8s infinite; }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(5px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(21, 25, 35, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="h-screen w-screen relative flex flex-col">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none w-max max-w-[90%]"></div>

    <!-- Settings Modal -->
    <dialog id="settings-modal" class="bg-transparent p-0 backdrop:bg-black/80 backdrop:backdrop-blur-sm w-full max-w-md m-auto">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl p-6 text-white mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5 text-indigo-400"></i> Settings</h2>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-6">
                <!-- Profile Customization -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-3">Profile</label>
                    <div class="flex items-center gap-4 mb-4">
                        <div id="modal-avatar-preview" class="w-16 h-16 rounded-full flex items-center justify-center text-3xl shadow-lg border-2 border-slate-700 transition-all"></div>
                        <div class="flex-1">
                            <input type="text" id="modal-username" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 outline-none mb-2" placeholder="Display Name">
                            <div class="text-[10px] text-slate-500">Pick an avatar below:</div>
                        </div>
                    </div>
                    
                    <!-- Modal Avatar Picker -->
                    <div class="grid grid-cols-5 gap-2 p-2 bg-slate-800/50 rounded-xl border border-slate-700/50">
                        <button onclick="selectModalAvatar('üëæ', 'bg-indigo-600')" class="h-10 w-10 rounded-full bg-indigo-600 flex items-center justify-center hover:scale-110 transition mx-auto text-lg">üëæ</button>
                        <button onclick="selectModalAvatar('üê±', 'bg-purple-600')" class="h-10 w-10 rounded-full bg-purple-600 flex items-center justify-center hover:scale-110 transition mx-auto text-lg">üê±</button>
                        <button onclick="selectModalAvatar('ü§ñ', 'bg-emerald-600')" class="h-10 w-10 rounded-full bg-emerald-600 flex items-center justify-center hover:scale-110 transition mx-auto text-lg">ü§ñ</button>
                        <button onclick="selectModalAvatar('ü¶ä', 'bg-orange-600')" class="h-10 w-10 rounded-full bg-orange-600 flex items-center justify-center hover:scale-110 transition mx-auto text-lg">ü¶ä</button>
                        <button onclick="selectModalAvatar('üëª', 'bg-pink-600')" class="h-10 w-10 rounded-full bg-pink-600 flex items-center justify-center hover:scale-110 transition mx-auto text-lg">üëª</button>
                    </div>
                    
                    <!-- Hidden fields for modal state -->
                    <input type="hidden" id="modal-selected-avatar">
                    <input type="hidden" id="modal-selected-color">
                </div>
                
                <!-- Host Controls -->
                <div id="host-settings-group" class="hidden space-y-4 pt-4 border-t border-slate-800">
                    <div class="p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-3">Room Security</label>
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm">Lock Room <i data-lucide="lock" class="inline w-3 h-3 text-slate-500 ml-1"></i></span>
                            <button id="btn-lock-room" onclick="toggleRoomLock()" class="w-10 h-5 rounded-full bg-slate-700 relative transition-colors">
                                <div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform"></div>
                            </button>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm">Host-Only Controls</span>
                            <button id="btn-host-only" onclick="toggleHostOnly()" class="w-10 h-5 rounded-full bg-slate-700 relative transition-colors">
                                <div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI Key -->
                <div class="pt-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">AI Integration</label>
                    <div class="relative">
                        <input type="password" id="ai-api-key" placeholder="Paste Gemini API Key" class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-3 pr-8 py-2 text-xs focus:border-purple-500 outline-none">
                        <i data-lucide="key" class="absolute right-2 top-2 w-3.5 h-3.5 text-slate-500"></i>
                    </div>
                </div>

                <button onclick="saveSettings()" class="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-lg font-bold text-sm shadow-lg transition-colors">Save Changes</button>
                <div class="pt-4 border-t border-slate-700 text-center">
                    <p class="text-[10px] text-slate-500">NearWatch v2.0 ‚Ä¢ P2P Encrypted</p>
                    <p class="text-[10px] text-slate-600 font-medium mt-1">Copyright ¬© Efrat Al Ahad</p>
                </div>
            </div>
        </div>
    </dialog>

    <!-- Login View -->
    <div id="login-view" class="absolute inset-0 z-50 flex items-center justify-center bg-[#0b0e14] bg-[url('https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80&w=2525&auto=format&fit=crop')] bg-cover bg-center">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
        
        <div class="relative glass-panel p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-8">
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 w-14 h-14 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-500/20">
                    <i data-lucide="monitor-play" class="text-white w-7 h-7"></i>
                </div>
                <h1 class="text-2xl font-bold text-white tracking-tight mb-2">NearWatch</h1>
                <div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-[10px] font-bold uppercase tracking-wider">
                    <i data-lucide="shield-check" class="w-3 h-3"></i>
                    <span>P2P Encrypted</span>
                </div>
            </div>

            <!-- Avatar Selector -->
            <div class="flex justify-center gap-4 mb-8">
                <div class="avatar-option w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-lg border-2 border-transparent shadow-lg" onclick="selectAvatar('üëæ', 'bg-indigo-600')">üëæ</div>
                <div class="avatar-option w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center text-lg border-2 border-transparent shadow-lg" onclick="selectAvatar('üê±', 'bg-purple-600')">üê±</div>
                <div class="avatar-option w-10 h-10 rounded-full bg-emerald-600 flex items-center justify-center text-lg border-2 border-transparent shadow-lg" onclick="selectAvatar('ü§ñ', 'bg-emerald-600')">ü§ñ</div>
                <div class="avatar-option w-10 h-10 rounded-full bg-orange-600 flex items-center justify-center text-lg border-2 border-transparent shadow-lg" onclick="selectAvatar('ü¶ä', 'bg-orange-600')">ü¶ä</div>
            </div>

            <div class="space-y-6">
                <!-- Name Input -->
                <div class="space-y-1.5">
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="user" class="h-4 w-4 text-slate-500"></i>
                        </div>
                        <input type="text" id="username-input" placeholder="Display Name" class="w-full bg-[#0f1218] border border-slate-700 rounded-xl pl-10 pr-4 py-3 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition text-sm placeholder-slate-500">
                    </div>
                </div>
                
                <!-- Create/Join Toggle -->
                <div class="grid grid-cols-2 gap-1 p-1 bg-[#0f1218] rounded-xl border border-slate-800">
                    <button onclick="switchMode('create')" id="btn-mode-create" class="py-2 text-xs font-bold rounded-lg transition-all bg-indigo-600 text-white shadow-lg">Create Room</button>
                    <button onclick="switchMode('join')" id="btn-mode-join" class="py-2 text-xs font-bold rounded-lg transition-all text-slate-400 hover:text-white">Join Room</button>
                </div>

                <!-- Create Room Input -->
                <div id="create-input-group" class="space-y-1.5 relative">
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="key" class="h-4 w-4 text-slate-500"></i>
                        </div>
                        <input type="text" id="create-id-input" placeholder="Room ID (Optional)" class="w-full bg-[#0f1218] border border-slate-700 rounded-xl pl-10 pr-12 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition text-sm placeholder-slate-500">
                        <button onclick="fillRandomId()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-500 hover:text-indigo-400 transition-colors" title="Generate Random ID">
                            <i data-lucide="dices" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <p class="text-[10px] text-slate-500 pl-1 mt-1">Leave blank for random ID.</p>
                </div>

                <!-- Join Room Input -->
                <div id="join-input-group" class="hidden space-y-1.5 relative">
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="link" class="h-4 w-4 text-slate-500"></i>
                        </div>
                        <input type="text" id="join-id-input" placeholder="Enter Room ID" class="w-full bg-[#0f1218] border border-slate-700 rounded-xl pl-10 pr-4 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition text-sm placeholder-slate-500">
                    </div>
                </div>

                <button onclick="handleStart()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg transition transform active:scale-[0.98] text-sm uppercase tracking-wide flex items-center justify-center gap-2" id="action-btn">
                    Create Room
                </button>
                <p id="status-msg" class="text-center text-xs text-slate-400 h-4"></p>
            </div>
        </div>
    </div>

    <!-- App View -->
    <div id="app-view" class="flex flex-col h-full hidden bg-[#0b0e14]">
        <!-- Header -->
        <header class="h-14 border-b border-slate-800 flex items-center justify-between px-4 z-20 shrink-0 bg-[#0b0e14]">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-1.5 rounded-lg">
                    <i data-lucide="monitor-play" class="text-white w-4 h-4"></i>
                </div>
                <div class="hidden sm:block">
                    <h1 class="font-bold text-white text-sm tracking-tight">NearWatch</h1>
                </div>
            </div>
            
            <!-- Room Info & Status -->
            <div class="flex items-center gap-2 bg-[#151923] border border-slate-800 rounded-full px-3 py-1">
                <span id="sync-dot" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                <p class="text-[10px] text-slate-400 cursor-pointer hover:text-indigo-400 transition flex items-center gap-2" onclick="copyId()">
                    <span id="my-peer-id" class="font-mono max-w-[80px] sm:max-w-[150px] truncate">...</span> 
                    <i data-lucide="copy" class="w-3 h-3"></i>
                </p>
                <div id="room-locked-indicator" class="hidden">
                    <i data-lucide="lock" class="w-3 h-3 text-red-400"></i>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="toggleMobileChat()" class="lg:hidden text-slate-400 hover:text-white p-2 relative">
                    <i data-lucide="message-square" class="w-5 h-5"></i>
                    <span id="chat-badge" class="absolute top-1 right-1 w-2 h-2 bg-indigo-500 rounded-full hidden"></span>
                </button>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-white transition"><i data-lucide="settings" class="w-5 h-5"></i></button>
                <div id="user-avatar-display" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center font-bold text-sm shadow-inner cursor-pointer" onclick="toggleSettings()">?</div>
            </div>
        </header>

        <main class="flex-1 flex overflow-hidden relative">
            <!-- Left: Video & Controls -->
            <div class="flex-1 flex flex-col bg-black relative w-full h-full">
                <!-- Floating Source Input -->
                <div class="absolute top-4 left-1/2 -translate-x-1/2 w-[95%] max-w-2xl z-20 opacity-0 hover:opacity-100 transition duration-300">
                    <div class="flex flex-wrap justify-center gap-2 bg-[#151923]/90 backdrop-blur p-1.5 rounded-xl border border-slate-700 shadow-2xl">
                        <div class="flex items-center flex-1 min-w-[150px] gap-2">
                            <input type="text" id="url-input" placeholder="YouTube / MP4 URL" class="bg-transparent border-none text-xs w-full text-white focus:ring-0 outline-none pl-2">
                            <button onclick="loadVideo()" class="bg-indigo-600 hover:bg-indigo-500 px-3 py-1.5 rounded-lg text-xs font-bold text-white transition">Play</button>
                        </div>
                        <div class="w-px h-6 bg-slate-700 hidden sm:block"></div>
                        <button onclick="document.getElementById('file-input').click()" class="flex items-center gap-2 bg-[#1f2937] hover:bg-slate-700 px-3 py-1.5 rounded-lg text-xs text-white border border-slate-700 transition">
                            <i data-lucide="file-video" class="w-3 h-3 text-emerald-500"></i> <span class="hidden sm:inline">File</span>
                        </button>
                        <input type="file" id="file-input" class="hidden" accept="video/*" onchange="handleFile(this)">
                    </div>
                </div>

                <!-- Video Stage -->
                <div class="flex-1 overflow-hidden bg-[#000] flex flex-col justify-center items-center">
                    <div class="video-wrapper">
                        <div id="video-box" class="video-container">
                            <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-[#0b0e14] text-slate-500 z-10">
                                <i data-lucide="film" class="w-12 h-12 md:w-16 md:h-16 mb-4 opacity-30"></i>
                                <h3 class="text-lg font-bold text-white mb-1">Ready?</h3>
                                <p class="text-xs text-slate-500">Paste link or load file</p>
                            </div>
                            <video id="html5-player" class="hidden" controls playsinline crossorigin="anonymous">
                                <track id="player-track" kind="subtitles" srclang="en" label="English" default>
                            </video>
                            <div id="youtube-player" class="hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Controls Bar -->
                <div class="w-full bg-[#151923] border-t border-slate-800 px-4 py-3 flex items-center justify-between shrink-0 z-20">
                    <div class="flex items-center gap-4">
                        <!-- Rewind/Forward -->
                        <div class="flex gap-2">
                            <button onclick="seekRelative(-10)" class="text-slate-400 hover:text-white transition" title="-10s"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button>
                            <button onclick="seekRelative(10)" class="text-slate-400 hover:text-white transition" title="+10s"><i data-lucide="rotate-cw" class="w-5 h-5"></i></button>
                        </div>

                        <!-- Speed -->
                        <div class="relative group">
                            <select id="speed-select" onchange="changeSpeed(this.value)" class="bg-[#0b0e14] text-slate-300 text-xs border border-slate-700 rounded px-2 py-1 focus:border-indigo-500 outline-none appearance-none pr-6 cursor-pointer">
                                <option value="0.5">0.5x</option>
                                <option value="1" selected>1.0x</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                                <option value="2">2.0x</option>
                            </select>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-slate-500 absolute right-1.5 top-1.5 pointer-events-none"></i>
                        </div>

                        <!-- Subtitles -->
                        <button onclick="document.getElementById('sub-input').click()" class="text-slate-400 hover:text-white transition" title="Subtitles"><i data-lucide="captions" class="w-5 h-5"></i></button>
                        <input type="file" id="sub-input" accept=".vtt,.srt" class="hidden" onchange="handleSubtitle(this)">
                    </div>

                    <!-- Quote Ticker -->
                    <div id="quote-container" class="hidden md:flex flex-1 justify-center items-center overflow-hidden mx-4">
                        <p id="quote-text" class="text-xs text-slate-500 italic truncate max-w-[400px] quote-fade text-center font-medium">Watch together. No limits.</p>
                    </div>

                    <!-- Right Controls -->
                    <div class="flex items-center gap-3">
                        <button onclick="toggleFullscreen()" class="text-slate-400 hover:text-white transition"><i data-lucide="maximize" class="w-5 h-5"></i></button>
                    </div>
                </div>
            </div>

            <!-- Right: Chat & Sidebar (Responsive) -->
            <div id="chat-sidebar" class="fixed inset-y-0 right-0 z-30 w-80 bg-[#151923] border-l border-slate-800 flex flex-col transition-transform duration-300 transform translate-x-full lg:translate-x-0 lg:static">
                <!-- Mobile Close Button -->
                <button onclick="toggleMobileChat()" class="lg:hidden absolute top-3 right-3 p-2 text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                
                <!-- Sidebar Tabs -->
                <div class="flex border-b border-slate-800 mt-10 lg:mt-0">
                    <button onclick="switchTab('chat')" id="tab-chat" class="tab-btn active w-1/2">Chat</button>
                    <button onclick="switchTab('users')" id="tab-users" class="tab-btn inactive w-1/2 flex items-center justify-center gap-1">Users <span id="user-count" class="text-[9px] bg-slate-800 px-1.5 py-0.5 rounded-full text-slate-400">1</span></button>
                </div>
                
                <!-- Chat View -->
                <div id="view-chat" class="flex-1 flex flex-col overflow-hidden bg-[#0b0e14]">
                    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3">
                        <div class="text-center text-[10px] text-slate-600 my-4 uppercase tracking-widest font-bold">Room Created</div>
                    </div>
                    <!-- Chat Interactions -->
                    <div class="p-3 bg-[#151923] border-t border-slate-800 relative">
                        <div class="flex gap-2 mb-3 overflow-x-auto no-scrollbar pb-1">
                            <button onclick="sendEmoji('üëã')" class="text-xl hover:scale-110 transition">üëã</button>
                            <button onclick="sendEmoji('üòÇ')" class="text-xl hover:scale-110 transition">üòÇ</button>
                            <button onclick="sendEmoji('üî•')" class="text-xl hover:scale-110 transition">üî•</button>
                            <button onclick="sendEmoji('üòÆ')" class="text-xl hover:scale-110 transition">üòÆ</button>
                            <button onclick="sendEmoji('‚ù§Ô∏è')" class="text-xl hover:scale-110 transition">‚ù§Ô∏è</button>
                            <div class="w-px h-6 bg-slate-700 mx-1"></div>
                            <button onclick="askAI('Suggest a movie')" class="whitespace-nowrap text-[10px] bg-purple-500/10 text-purple-300 px-2.5 py-1 rounded-full border border-purple-500/20 hover:bg-purple-500/20 transition">‚ú® Idea</button>
                        </div>
                        <form onsubmit="sendChat(event)" class="relative">
                            <input id="chat-input" type="text" placeholder="Type a message..." class="w-full bg-[#0b0e14] border border-slate-700 rounded-xl py-3 pl-4 pr-10 text-xs text-white focus:border-indigo-500 outline-none transition placeholder-slate-600">
                            <button type="submit" class="absolute right-2 top-2.5 text-slate-400 hover:text-indigo-500"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                        </form>
                    </div>
                </div>

                <!-- Users View -->
                <div id="view-users" class="flex-1 hidden overflow-y-auto p-4 bg-[#0b0e14]">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-4 tracking-widest">Participants</h3>
                    <div id="user-list-container" class="space-y-2"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const generateId = () => Math.random().toString(36).substring(2, 8);
        let peer;
        let connections = []; // For Host
        let hostConn = null;  // For Guest
        let isSyncing = false; // Lock to prevent loop
        let apiKey = ""; // AI Key
        let connTimeout = null;
        let userList = [];
        const quotes = [
            "Watch together. No lag. No limits.", "Tonight, we‚Äôre not alone.", "Turn loneliness into togetherness.", 
            "Distance shouldn‚Äôt pause the movie.", "Press play. Feel close.", "Together, even miles apart.", 
            "Same screen. Same moment.", "Turn distance into togetherness."
        ];
        
        // Sound Effect
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playNotificationSound() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        const state = {
            mode: 'create', // create | join
            id: null,
            username: 'Guest',
            avatar: 'üëæ',
            color: 'bg-indigo-600',
            hostOnly: false,
            isLocked: false,
            maxUsers: 10,
            isCoHost: false, 
            video: { type: null, src: null, time: 0, state: 'paused', speed: 1.0 },
            ytPlayer: null
        };

        // --- INIT ---
        window.onload = () => {
            lucide.createIcons();
            loadProfile();
            startQuoteTicker();
            
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('join')) {
                switchMode('join');
                document.getElementById('join-id-input').value = urlParams.get('join');
            }
        };

        function startQuoteTicker() {
            let idx = 0;
            setInterval(() => {
                idx = (idx + 1) % quotes.length;
                const el = document.getElementById('quote-text');
                if(el) {
                    el.classList.remove('quote-fade');
                    void el.offsetWidth; // reflow
                    el.innerText = quotes[idx];
                    el.classList.add('quote-fade');
                }
            }, 8000);
        }

        function loadProfile() {
            const saved = localStorage.getItem('zg_p2p_profile');
            if(saved) {
                const p = JSON.parse(saved);
                document.getElementById('username-input').value = p.name;
                document.getElementById('modal-username').value = p.name;
                selectAvatar(p.avatar, p.color, true); // Update login avatar
                selectModalAvatar(p.avatar, p.color); // Update modal avatar preview
                apiKey = p.apiKey || "";
                document.getElementById('ai-api-key').value = apiKey;
            } else {
                // Default selection
                selectAvatar('üëæ', 'bg-indigo-600', true);
                selectModalAvatar('üëæ', 'bg-indigo-600');
            }
        }

        // --- LOGIN LOGIC ---
        function switchMode(mode) {
            state.mode = mode;
            const btnCreate = document.getElementById('btn-mode-create');
            const btnJoin = document.getElementById('btn-mode-join');
            const actionBtn = document.getElementById('action-btn');
            const createGroup = document.getElementById('create-input-group');
            const joinGroup = document.getElementById('join-input-group');

            if(mode === 'create') {
                btnCreate.className = "py-2 text-xs font-bold rounded-lg transition-all bg-indigo-600 text-white shadow-lg";
                btnJoin.className = "py-2 text-xs font-bold rounded-lg transition-all text-slate-400 hover:text-white hover:bg-slate-800";
                
                actionBtn.innerText = "Create Room";
                createGroup.classList.remove('hidden');
                joinGroup.classList.add('hidden');
            } else {
                btnJoin.className = "py-2 text-xs font-bold rounded-lg transition-all bg-indigo-600 text-white shadow-lg";
                btnCreate.className = "py-2 text-xs font-bold rounded-lg transition-all text-slate-400 hover:text-white hover:bg-slate-800";

                actionBtn.innerText = "Join Room";
                createGroup.classList.add('hidden');
                joinGroup.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        function fillRandomId() {
            document.getElementById('create-id-input').value = generateId();
        }

        function selectAvatar(av, col, isLogin = false) {
            if(isLogin) {
                state.avatar = av; state.color = col;
                // Update login screen visual
                document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                // Basic matching for demo purposes
                const options = document.querySelectorAll('.avatar-option');
                for(let opt of options) {
                    if(opt.innerText === av) opt.classList.add('selected');
                }
            }
        }

        function selectModalAvatar(av, col) {
            // Update state
            state.avatar = av; state.color = col;
            
            // Update Modal UI
            const preview = document.getElementById('modal-avatar-preview');
            preview.innerText = av;
            preview.className = `w-16 h-16 rounded-full flex items-center justify-center text-3xl shadow-lg border-2 border-slate-700 transition-all ${col}`;
            
            // Store temporarily in hidden fields if we want cancel logic, 
            // but for this simple version we update state directly.
        }

        async function handleStart() {
            const name = document.getElementById('username-input').value.trim();
            if(!name) return toast("Please enter a name", "error");
            state.username = name;
            
            localStorage.setItem('zg_p2p_profile', JSON.stringify({
                name, avatar: state.avatar, color: state.color, apiKey
            }));

            const btn = document.getElementById('action-btn');
            btn.disabled = true;
            btn.innerText = "Connecting...";
            document.getElementById('status-msg').innerText = "Establishing Secure Connection...";

            if(state.mode === 'create') {
                const inputId = document.getElementById('create-id-input').value.trim().replace(/[^a-zA-Z0-9-_]/g, '');
                state.id = inputId || generateId();
                state.hostOnly = false;
                state.isLocked = false;
                state.isCoHost = true; 
                initPeer(state.id);
            } else {
                const inputId = document.getElementById('join-id-input').value.trim().replace(/[^a-zA-Z0-9-_]/g, '');
                if(!inputId) {
                    resetLoginUI("Enter a Host ID to join.");
                    return;
                }
                state.id = generateId(); 
                initPeer(state.id, inputId);
            }
        }

        function resetLoginUI(msg = "") {
            const btn = document.getElementById('action-btn');
            btn.disabled = false;
            btn.innerText = state.mode === 'create' ? "Create Room" : "Join Room";
            document.getElementById('status-msg').innerText = "";
            if(msg) toast(msg, "error");
        }

        // --- PEERJS LOGIC ---
        function initPeer(myId, targetHostId = null) {
            const cleanId = myId.replace(/[^a-zA-Z0-9-_]/g, '');
            peer = new Peer(cleanId, { debug: 1 });

            peer.on('open', (id) => {
                if(targetHostId) {
                    connectToHost(targetHostId);
                } else {
                    enterApp(id);
                    // setStatus("Hosting", "bg-indigo-500");
                    document.getElementById('host-settings-group').classList.remove('hidden');
                    userList = [{ id: id, username: state.username, avatar: state.avatar, color: state.color, isCoHost: true }];
                    updateUserListUI();
                }
            });

            peer.on('connection', (conn) => {
                if (state.mode === 'create') {
                    if (state.isLocked) {
                        conn.on('open', () => { conn.send({ type: 'error', msg: "Room is Locked." }); setTimeout(() => conn.close(), 500); });
                        return;
                    }
                    if (connections.length >= state.maxUsers) {
                        conn.on('open', () => { conn.send({ type: 'error', msg: "Room is Full." }); setTimeout(() => conn.close(), 500); });
                        return;
                    }
                }
                connections.push(conn);
                setupConnection(conn);
                if(state.mode === 'create') {
                    setTimeout(() => {
                        if(conn.open) {
                            conn.send({ type: 'sync-full', video: state.video, hostOnly: state.hostOnly, isLocked: state.isLocked });
                            broadcastUserList(); 
                        }
                    }, 1000);
                }
            });

            peer.on('error', (err) => {
                console.error(err);
                let msg = "Connection Error";
                if(err.type === 'unavailable-id') msg = "ID taken. Try another.";
                if(err.type === 'peer-unavailable') msg = "Host not found.";
                toast(msg, "error");
                resetLoginUI(msg);
            });
        }

        function connectToHost(hostId) {
            hostConn = peer.connect(hostId, {
                metadata: { username: state.username, avatar: state.avatar, color: state.color },
                reliable: true // Improved reliability
            });
            document.getElementById('status-msg').innerText = "Locating Host...";
            
            // Increased timeout to 15 seconds to handle network latency
            connTimeout = setTimeout(() => {
                if(!hostConn || !hostConn.open) {
                    resetLoginUI("Connection timed out. Is Host online?");
                    if(peer) {
                        peer.destroy();
                        peer = null;
                    }
                }
            }, 15000);

            hostConn.on('open', () => {
                clearTimeout(connTimeout);
                enterApp(hostId);
                // setStatus("Connected", "bg-emerald-500"); // Removed to use header UI
                addSystemMsg("Joined Room!");
                setupConnection(hostConn);
                document.getElementById('my-peer-id').innerText = hostId;
            });
            
            hostConn.on('close', () => {
                toast("Host Disconnected", "error");
                setTimeout(() => location.reload(), 2000);
            });
            
            hostConn.on('error', (e) => {
                clearTimeout(connTimeout);
                resetLoginUI("Could not connect to Host.");
            });
        }

        function setupConnection(conn) {
            if(state.mode === 'create' && conn.metadata) {
                const { username, avatar, color } = conn.metadata;
                userList.push({ id: conn.peer, username, avatar, color, isCoHost: false });
                broadcastUserList();
                const msg = `${username} joined`;
                broadcast({ type: 'system', msg });
                addSystemMsg(msg);
                playNotificationSound();
            }
            conn.on('data', (data) => handleData(data, conn));
            conn.on('close', () => {
                if(state.mode === 'create') {
                    connections = connections.filter(c => c !== conn);
                    const userIdx = userList.findIndex(u => u.id === conn.peer);
                    if(userIdx !== -1) {
                        const user = userList[userIdx];
                        userList.splice(userIdx, 1);
                        broadcastUserList();
                        const msg = `${user.username} left`;
                        addSystemMsg(msg);
                        broadcast({ type: 'system', msg });
                    }
                }
            });
        }

        function enterApp(id) {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            if(state.mode === 'create') document.getElementById('my-peer-id').innerText = id;
            updateProfileUI();
            initYouTube();
        }

        function updateProfileUI() {
            const el = document.getElementById('user-avatar-display');
            el.innerText = state.avatar;
            el.className = `w-9 h-9 rounded-full ${state.color} flex items-center justify-center font-bold text-sm shadow-inner cursor-pointer`;
        }

        // --- USER LIST ---
        function broadcastUserList() { broadcast({ type: 'user-list', list: userList }); updateUserListUI(); }
        function updateUserListUI() {
            const container = document.getElementById('user-list-container');
            document.getElementById('user-count').innerText = userList.length;
            container.innerHTML = '';
            userList.forEach(user => {
                const isMe = user.id === (state.mode === 'create' ? state.id : peer.id);
                const role = user.isCoHost ? (user.id === state.id && state.mode === 'create' ? 'HOST' : 'CO-HOST') : 'USER';
                const roleColor = user.isCoHost ? 'text-indigo-400' : 'text-slate-500';
                
                let controls = '';
                if(state.mode === 'create' && !isMe) {
                    controls = `<div class="flex gap-2 opacity-0 group-hover:opacity-100 transition"><button onclick="promoteUser('${user.id}')" title="Promote" class="text-indigo-400 hover:text-white"><i data-lucide="shield-plus" class="w-4 h-4"></i></button><button onclick="kickUser('${user.id}')" title="Kick" class="text-red-400 hover:text-white"><i data-lucide="user-x" class="w-4 h-4"></i></button></div>`;
                }
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-2 rounded-lg hover:bg-slate-800/50 group transition";
                div.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full ${user.color} flex items-center justify-center text-sm font-bold shadow-sm">${user.avatar}</div><div><p class="text-xs font-bold text-slate-200 flex items-center gap-1">${user.username} ${isMe ? '<span class="text-[9px] bg-slate-700 px-1 rounded text-slate-400">YOU</span>' : ''}</p><p class="text-[9px] ${roleColor} font-medium">${role}</p></div></div>${controls}`;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function kickUser(userId) {
            if(state.mode !== 'create') return;
            const conn = connections.find(c => c.peer === userId);
            if(conn) { conn.send({ type: 'error', msg: "Kicked by Host." }); setTimeout(() => conn.close(), 500); }
        }
        function promoteUser(userId) {
            if(state.mode !== 'create') return;
            const user = userList.find(u => u.id === userId);
            if(user) {
                user.isCoHost = !user.isCoHost; 
                broadcastUserList(); 
                const conn = connections.find(c => c.peer === userId);
                if(conn) conn.send({ type: 'promote', val: user.isCoHost });
                toast(`Updated ${user.username}`, 'success');
            }
        }

        // --- CORE DATA HANDLING ---
        function handleData(data, senderConn) {
            if (data.type === 'error') { alert(data.msg); location.reload(); return; }
            if (data.type === 'chat') {
                addChat(data.user, data.msg, data.avatar, data.color);
                playNotificationSound();
                if(document.getElementById('chat-sidebar').classList.contains('closed')) document.getElementById('chat-badge').classList.remove('hidden');
                if(state.mode === 'create') broadcast(data, senderConn);
            }
            else if (data.type === 'system') {
                addSystemMsg(data.msg);
                if(state.mode === 'create') broadcast(data, senderConn);
            }
            else if (data.type === 'video-action') {
                if(state.mode === 'create' && state.hostOnly && !data.isHost) return;
                applyVideoAction(data.action, data.val);
                if(state.mode === 'create') broadcast(data, senderConn);
            }
            else if (data.type === 'sync-full') {
                state.hostOnly = data.hostOnly;
                updateLockUI(data.isLocked);
                if(data.video.type === 'youtube') {
                    document.getElementById('url-input').value = `https://youtu.be/${data.video.src}`;
                    state.video = data.video;
                    loadVideo(true);
                } else if(data.video.type === 'file') {
                    addSystemMsg("Host is watching a local file. Please load same file.");
                }
                if(data.video.speed) changeSpeed(data.video.speed, true);
            }
            else if (data.type === 'settings') {
                if(data.key === 'hostOnly') state.hostOnly = data.val;
                if(data.key === 'isLocked') updateLockUI(data.val);
            }
            else if (data.type === 'user-list') { userList = data.list; updateUserListUI(); }
            else if (data.type === 'promote') { state.isCoHost = data.val; toast(state.isCoHost ? "You are now Co-Host" : "Co-Host removed", "info"); }
            else if (data.type === 'update-profile') {
                if (state.mode === 'create') {
                    const u = userList.find(u => u.id === senderConn.peer);
                    if (u) {
                        u.username = data.username; u.avatar = data.avatar; u.color = data.color;
                        broadcastUserList();
                    }
                }
            }
        }

        function broadcast(data, excludeConn = null) {
            connections.forEach(c => { if(c !== excludeConn && c.open) c.send(data); });
        }

        // --- VIDEO LOGIC ---
        function initYouTube() {
            if(!window.YT) { const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; document.body.appendChild(tag); }
        }
        function loadVideo(isRemote = false) {
            const url = document.getElementById('url-input').value;
            const ytId = extractYouTubeId(url);
            if(ytId) {
                state.video.type = 'youtube'; state.video.src = ytId;
                activatePlayer('youtube');
                if(!state.ytPlayer) {
                    state.ytPlayer = new YT.Player('youtube-player', {
                        height: '100%', width: '100%', videoId: ytId,
                        playerVars: { autoplay: 1, controls: 0, rel: 0 },
                        events: { onStateChange: onPlayerStateChange }
                    });
                } else { state.ytPlayer.loadVideoById(ytId); }
                if(!isRemote) sendVideoAction('change', { type: 'youtube', src: ytId });
            }
        }
        function handleFile(input) {
            const file = input.files[0]; if(!file) return;
            const url = URL.createObjectURL(file);
            if(state.ytPlayer && state.ytPlayer.stopVideo) state.ytPlayer.stopVideo();
            state.video.type = 'file';
            activatePlayer('html5');
            const v = document.getElementById('html5-player');
            v.src = url; v.playbackRate = state.video.speed;
            v.onplay = () => sendVideoAction('play', v.currentTime);
            v.onpause = () => sendVideoAction('pause', v.currentTime);
            v.onseeked = () => sendVideoAction('seek', v.currentTime);
            toast("Local file loaded.", "success");
            if(state.mode === 'create') broadcast({ type: 'video-action', action: 'change', val: { type: 'file' }});
            input.value = '';
        }
        function onPlayerStateChange(e) {
            if(isSyncing) return;
            if(e.data == YT.PlayerState.PLAYING) sendVideoAction('play', state.ytPlayer.getCurrentTime());
            if(e.data == YT.PlayerState.PAUSED) sendVideoAction('pause', state.ytPlayer.getCurrentTime());
        }
        function sendVideoAction(action, val) {
            if(isSyncing) return;
            if(state.mode !== 'create' && state.hostOnly && !state.isCoHost) { toast("Host Locked Controls", "error"); return; }
            const data = { type: 'video-action', action, val, isHost: state.mode === 'create' || state.isCoHost };
            if(action === 'play') state.video.state = 'playing';
            if(action === 'pause') state.video.state = 'paused';
            if(action === 'seek') state.video.time = val;
            if(action === 'speed') state.video.speed = val;
            if(state.mode === 'create') broadcast(data); else if(hostConn && hostConn.open) hostConn.send(data);
        }
        function applyVideoAction(action, val) {
            isSyncing = true;
            const yt = state.ytPlayer; const h5 = document.getElementById('html5-player');
            if(action === 'change') {
                if(val.type === 'youtube') { document.getElementById('url-input').value = `https://youtu.be/${val.src}`; loadVideo(true); }
                else if(val.type === 'file') { addSystemMsg("Host changed to Local File."); }
            }
            else if(action === 'speed') changeSpeed(val, true);
            else if(state.video.type === 'youtube' && yt && yt.getPlayerState) {
                if(action === 'play') { if(Math.abs(yt.getCurrentTime() - val) > 1) yt.seekTo(val); yt.playVideo(); }
                if(action === 'pause') { yt.seekTo(val); yt.pauseVideo(); }
                if(action === 'seek') yt.seekTo(val);
            }
            else if(state.video.type === 'file') {
                if(action === 'play') { if(Math.abs(h5.currentTime - val) > 1) h5.currentTime = val; h5.play().catch(e=>{}); }
                if(action === 'pause') { h5.pause(); h5.currentTime = val; }
                if(action === 'seek') h5.currentTime = val;
            }
            setTimeout(() => { isSyncing = false; }, 500);
        }
        function seekRelative(seconds) {
            if(state.mode !== 'create' && state.hostOnly && !state.isCoHost) { toast("Controls Locked", "error"); return; }
            let current = 0;
            if(state.video.type === 'youtube' && state.ytPlayer) current = state.ytPlayer.getCurrentTime();
            else if(state.video.type === 'file') current = document.getElementById('html5-player').currentTime;
            const newTime = Math.max(0, current + seconds);
            sendVideoAction('seek', newTime);
            // Apply locally immediately for responsiveness
            if(state.video.type === 'youtube') state.ytPlayer.seekTo(newTime);
            else if(state.video.type === 'file') document.getElementById('html5-player').currentTime = newTime;
        }
        function activatePlayer(type) {
            document.getElementById('placeholder').classList.add('hidden');
            const h5 = document.getElementById('html5-player'); const yt = document.getElementById('youtube-player');
            if(type === 'youtube') { h5.classList.add('hidden'); h5.pause(); yt.style.display = 'block'; }
            else { yt.style.display = 'none'; if(state.ytPlayer?.pauseVideo) state.ytPlayer.pauseVideo(); h5.classList.remove('hidden'); }
        }
        function extractYouTubeId(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }
        function changeSpeed(val, isRemote = false) {
            const speed = parseFloat(val); state.video.speed = speed;
            document.getElementById('speed-select').value = speed;
            const h5 = document.getElementById('html5-player'); h5.playbackRate = speed;
            if(state.ytPlayer?.setPlaybackRate) state.ytPlayer.setPlaybackRate(speed);
            if(!isRemote) sendVideoAction('speed', speed);
        }
        function handleSubtitle(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                let content = e.target.result;
                if(file.name.endsWith('.srt')) content = "WEBVTT\n\n" + content.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g, '$1.$2');
                const blob = new Blob([content], {type: 'text/vtt'});
                const url = URL.createObjectURL(blob);
                document.getElementById('player-track').src = url;
                if(document.getElementById('html5-player').textTracks[0]) document.getElementById('html5-player').textTracks[0].mode = 'showing';
                toast("Subtitles Loaded", "success");
            };
            reader.readAsText(file);
        }

        // --- AI & CHAT ---
        async function askAI(query) {
            const prompt = query || document.getElementById('chat-input').value.replace('@ai', '').trim();
            if(!prompt) return;
            if(!apiKey) return toast("API Key required", "error");
            sendChat(null, prompt); toast("Thinking...", "info");
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: "Short fun response: " + prompt }] }] })
                });
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Failed.";
                const msgData = { type: 'chat', msg: text, user: 'AI', avatar: '‚ú®', color: 'bg-purple-600' };
                addChat('AI', text, '‚ú®', 'bg-purple-600'); playNotificationSound();
                if(state.mode === 'create') broadcast(msgData); else if(hostConn) hostConn.send(msgData);
            } catch(e) { toast("AI Error", "error"); }
        }
        function sendChat(e, manualMsg = null) {
            if(e) e.preventDefault();
            const inp = document.getElementById('chat-input');
            const msg = manualMsg || inp.value.trim();
            if(!msg) return;
            if(msg.startsWith('@ai') && !manualMsg) { askAI(msg.replace('@ai', '').trim()); inp.value = ''; return; }
            const data = { type: 'chat', msg, user: state.username, avatar: state.avatar, color: state.color };
            addChat(state.username, msg, state.avatar, state.color, true); playNotificationSound();
            if(state.mode === 'create') broadcast(data); else if(hostConn) hostConn.send(data);
            if(inp) inp.value = '';
        }
        function sendEmoji(e) { sendChat(null, e); }
        function addChat(user, msg, avatar, color, isMe=false) {
            const box = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `flex gap-3 ${isMe ? 'flex-row-reverse' : ''} animate-fade`;
            div.innerHTML = `<div class="w-8 h-8 rounded-full ${color} flex items-center justify-center text-xs shrink-0 text-white shadow-sm">${avatar}</div><div class="${isMe ? 'bg-indigo-600 text-white' : 'bg-[#1f2937] text-slate-200'} p-3 rounded-2xl text-sm max-w-[85%] shadow-md"><p class="text-[9px] opacity-70 mb-1 font-bold uppercase tracking-wide">${user}</p><p class="leading-relaxed">${msg}</p></div>`;
            box.appendChild(div); box.scrollTop = box.scrollHeight;
        }
        function addSystemMsg(text) {
            const box = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = "text-center text-[10px] text-slate-500 my-3 bg-[#151923] py-1 px-3 rounded-full mx-auto inline-block border border-slate-800";
            div.innerText = text;
            box.appendChild(div); box.scrollTop = box.scrollHeight;
        }

        // --- UTILS ---
        function toggleSettings() { const m = document.getElementById('settings-modal'); if(m.open) m.close(); else m.showModal(); }
        function toggleMobileChat() { 
            const sb = document.getElementById('chat-sidebar');
            if(sb.classList.contains('translate-x-full')) { sb.classList.remove('translate-x-full'); document.getElementById('chat-badge').classList.add('hidden'); }
            else sb.classList.add('translate-x-full');
        }
        function toggleFullscreen() {
            const elem = document.getElementById('video-box');
            if (!document.fullscreenElement) { elem.requestFullscreen().catch(err => toast("FS Error", "error")); } 
            else { document.exitFullscreen(); }
        }
        function switchTab(tab) {
            const cChat = document.getElementById('view-chat'); const cUsers = document.getElementById('view-users');
            const tChat = document.getElementById('tab-chat'); const tUsers = document.getElementById('tab-users');
            if(tab === 'chat') { cChat.classList.remove('hidden'); cUsers.classList.add('hidden'); tChat.classList.replace('inactive', 'active'); tUsers.classList.replace('active', 'inactive'); }
            else { cChat.classList.add('hidden'); cUsers.classList.remove('hidden'); tUsers.classList.replace('inactive', 'active'); tChat.classList.replace('active', 'inactive'); }
        }
        function saveSettings() {
            const name = document.getElementById('modal-username').value;
            apiKey = document.getElementById('ai-api-key').value;
            if(name) state.username = name;
            localStorage.setItem('zg_p2p_profile', JSON.stringify({ name: state.username, avatar: state.avatar, color: state.color, apiKey }));
            
            // Sync Profile Update
            if(state.mode === 'create') { 
                const me = userList.find(u => u.id === state.id); 
                if(me) { me.username = name; me.avatar = state.avatar; me.color = state.color; }
                broadcastUserList();
                updateProfileUI();
            } else if(hostConn && hostConn.open) {
                hostConn.send({ type: 'update-profile', username: state.username, avatar: state.avatar, color: state.color });
                updateProfileUI();
            }
            toggleSettings(); toast("Settings Saved", "success");
        }
        function toggleHostOnly() {
            if(state.mode !== 'create') return toast("Host Only", "error");
            state.hostOnly = !state.hostOnly;
            const btn = document.getElementById('btn-host-only'); const knob = btn.firstElementChild;
            if(state.hostOnly) { btn.classList.add('bg-indigo-600'); btn.classList.remove('bg-slate-700'); knob.classList.add('translate-x-5'); }
            else { btn.classList.remove('bg-indigo-600'); btn.classList.add('bg-slate-700'); knob.classList.remove('translate-x-5'); }
            broadcast({ type: 'settings', key: 'hostOnly', val: state.hostOnly });
        }
        function toggleRoomLock() {
            if(state.mode !== 'create') return toast("Host Only", "error");
            state.isLocked = !state.isLocked;
            updateLockUI(state.isLocked);
            const btn = document.getElementById('btn-lock-room'); const knob = btn.firstElementChild;
            if(state.isLocked) { btn.classList.add('bg-indigo-600'); btn.classList.remove('bg-slate-700'); knob.classList.add('translate-x-5'); }
            else { btn.classList.remove('bg-indigo-600'); btn.classList.add('bg-slate-700'); knob.classList.remove('translate-x-5'); }
            broadcast({ type: 'settings', key: 'isLocked', val: state.isLocked });
        }
        function updateLockUI(locked) { const i = document.getElementById('room-locked-indicator'); if(locked) i.classList.remove('hidden'); else i.classList.add('hidden'); }
        function copyId() {
            const id = document.getElementById('my-peer-id').innerText;
            if(id === '...') return;
            navigator.clipboard.writeText(id).then(() => toast("Copied!", "success"));
        }
        function toast(msg, type='info') {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            let cl = 'bg-[#151923] border-slate-700';
            if(type=='success') cl='bg-emerald-900/80 border-emerald-500/50';
            if(type=='error') cl='bg-red-900/80 border-red-500/50';
            d.className = `${cl} text-white border px-4 py-3 rounded-xl text-xs font-bold shadow-2xl backdrop-blur-md flex items-center gap-3 toast-enter`;
            d.innerHTML = type === 'success' ? `<i data-lucide="check-circle" class="w-4 h-4 text-emerald-400"></i> ${msg}` : (type === 'error' ? `<i data-lucide="alert-circle" class="w-4 h-4 text-red-400"></i> ${msg}` : msg);
            c.appendChild(d); lucide.createIcons(); setTimeout(()=>d.remove(), 3000);
        }
    </script>
</body>
</html>
